<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Ê∑ªÂä†ÂÜÖËÅîSVGÂõæÊ†á‰Ωú‰∏∫favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><text x='0' y='14' font-size='14' fill='blue'>üìñ</text></svg>">
    <title>TXTËΩ¨EPUBËΩ¨Êç¢Â∑•ÂÖ∑ - ‰∏ì‰∏öÂ∞èËØ¥ÊéíÁâà</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ÂéüÊúâCSS‰øùÊåÅ‰∏çÂèò */
        :root {
            --primary: #4361ee;
            --primary-light: #4895ef;
            --secondary: #7209b7;
            --success: #4caf50;
            --warning: #f9a826;
            --danger: #e63946;
            --gray: #f5f5f5;
            --gray-dark: #e0e0e0;
            --text: #333333;
            --text-light: #666666;
            --white: #ffffff;
            --shadow: rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f8f9fa;
            color: var(--text);
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--white);
            border-radius: 16px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            border: 1px solid #e1e8ed;
        }

        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
            transform: rotate(30deg);
        }

        header h1 {
            font-size: 2.2rem;
            margin-bottom: 12px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            position: relative;
        }

        header p {
            opacity: 0.9;
            max-width: 700px;
            margin: 0 auto;
            font-size: 1.1rem;
            position: relative;
        }

        .progress-steps {
            display: flex;
            background: var(--gray);
            padding: 15px 20px;
            position: relative;
            border-bottom: 1px solid #e0e0e0;
        }

        .progress-bar {
            position: absolute;
            height: 4px;
            background: var(--primary);
            top: 50%;
            transform: translateY(-50%);
            transition: all 0.5s ease;
            z-index: 1;
            box-shadow: 0 0 8px rgba(67, 97, 238, 0.4);
        }

        .step {
            flex: 1;
            text-align: center;
            position: relative;
            z-index: 2;
        }

        .step-icon {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: var(--white);
            color: var(--text-light);
            font-weight: bold;
            border: 3px solid var(--gray-dark);
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .step.active .step-icon {
            background: var(--primary);
            color: var(--white);
            border-color: var(--primary);
            transform: scale(1.1);
        }

        .step.done .step-icon {
            background: var(--success);
            color: var(--white);
            border-color: var(--success);
        }

        .step-text {
            display: block;
            margin-top: 8px;
            font-size: 0.9rem;
            color: var(--text-light);
            font-weight: 500;
        }

        .step.active .step-text,
        .step.done .step-text {
            color: var(--text);
            font-weight: 600;
        }

        .content-section {
            padding: 30px;
            display: none;
            background: #ffffff;
        }

        .content-section.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h2 {
            font-size: 1.6rem;
            color: var(--primary);
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--gray);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        h2 i {
            background: rgba(67, 97, 238, 0.15);
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            color: var(--primary);
        }

        .control-group {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px dashed var(--gray-dark);
        }

        .control-group:last-child {
            border-bottom: none;
        }

        .control-group h3 {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-group h3 i {
            color: var(--primary);
            font-size: 1.2rem;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text);
            font-size: 1rem;
        }

        input, select, textarea {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid var(--gray-dark);
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #ffffff;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
            outline: none;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 20px;
        }

        .file-upload {
            border: 3px dashed var(--gray-dark);
            border-radius: 16px;
            padding: 40px 30px;
            margin: 20px 0;
            transition: all 0.3s ease;
            position: relative;
            background: var(--gray);
            cursor: pointer;
            /* ‰ΩøÁî®flexÂ∏ÉÂ±ÄÁ°Æ‰øùÂÆåÂÖ®Â±Ö‰∏≠ */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .file-upload:hover {
            border-color: var(--primary);
            background: rgba(67, 97, 238, 0.05);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(67, 97, 238, 0.1);
        }

        .file-upload i {
            font-size: 3.5rem;
            color: var(--primary-light);
            margin-bottom: 20px;
            transition: all 0.3s;
        }

        .file-upload:hover i {
            transform: scale(1.1);
            color: var(--primary);
        }

        .file-upload h3 {
            font-size: 1.4rem;
            margin-bottom: 10px;
            color: var(--text);
        }

        .file-upload p {
            color: var(--text-light);
            margin-bottom: 25px;
            font-size: 1rem;
        }

        .upload-btn {
            display: inline-block;
            background: var(--primary);
            color: white;
            padding: 14px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            font-size: 1.05rem;
            box-shadow: 0 4px 10px rgba(67, 97, 238, 0.3);
        }

        .upload-btn:hover {
            background: var(--primary-light);
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(67, 97, 238, 0.4);
        }

        input[type="file"] {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0;
            cursor: pointer;
        }

        .hierarchy-rules {
            background: var(--gray);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid #e0e0e0;
        }

        .level-group {
            background: var(--white);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid #eee;
        }

        .level-header {
            font-weight: bold;
            color: var(--secondary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 1.2rem;
        }

        .level-header i {
            margin-right: 10px;
            color: var(--secondary);
            font-size: 1.3rem;
        }

        .level-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 18px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 28px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary);
        }

        input:checked + .slider:before {
            transform: translateX(30px);
        }

        .chapter-preview {
            max-height: 450px;
            overflow-y: auto;
            border: 1px solid var(--gray-dark);
            border-radius: 12px;
            padding: 20px;
            margin-top: 25px;
            background: var(--white);
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.05);
        }

        .chapter-item {
            padding: 12px 15px;
            border-left: 4px solid var(--gray);
            margin-bottom: 10px;
            transition: all 0.3s ease;
            position: relative;
            border-radius: 8px;
            background: #ffffff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        }

        .chapter-item:hover {
            background: #f8f9ff;
            border-left-color: var(--primary);
            transform: translateX(5px);
        }

        .chapter-item.level-1 {
            border-left-color: var(--primary);
            font-weight: bold;
            padding-left: 20px;
            background: #f0f4ff;
        }

        .chapter-item.level-2 {
            padding-left: 30px;
            border-left-color: var(--primary-light);
        }

        .chapter-item.level-3 {
            padding-left: 40px;
            border-left-color: var(--warning);
        }

        .chapter-item.invalid {
            background: rgba(255, 213, 79, 0.15);
            border-left: 4px solid var(--warning);
        }

        .chapter-item.invalid::after {
            content: "!";
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--warning);
            color: white;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .chapter-label {
            font-size: 0.85rem;
            background: rgba(67, 97, 238, 0.15);
            color: var(--primary);
            padding: 4px 10px;
            border-radius: 20px;
            margin-right: 10px;
            font-weight: 600;
        }

        .btn-container {
            display: flex;
            justify-content: space-between;
            margin-top: 35px;
            gap: 15px;
        }

        .btn {
            padding: 14px 32px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-size: 1.05rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn i {
            font-size: 1.1rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
        }

        .btn-primary:hover {
            background: var(--primary-light);
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(67, 97, 238, 0.4);
        }

        .btn-outline {
            background: transparent;
            color: var(--text);
            border: 2px solid var(--gray-dark);
        }

        .btn-outline:hover {
            background: var(--gray);
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .btn-success {
            background: var(--success);
            color: white;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .btn-success:hover {
            background: #388e3c;
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(76, 175, 80, 0.4);
        }

        .alert {
            padding: 18px;
            border-radius: 12px;
            margin-bottom: 25px;
            display: flex;
            align-items: flex-start;
            gap: 15px;
            border-left: 5px solid;
        }

        .alert i {
            font-size: 1.6rem;
            flex-shrink: 0;
        }

        .alert-danger {
            background: rgba(230, 57, 70, 0.1);
            color: var(--danger);
            border-left-color: var(--danger);
        }

        .alert-info {
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary);
            border-left-color: var(--primary);
        }

        .alert-success {
            background: rgba(76, 175, 80, 0.1);
            color: var(--success);
            border-left-color: var(--success);
        }

        .progress-container {
            width: 100%;
            height: 14px;
            background: var(--gray-dark);
            border-radius: 7px;
            overflow: hidden;
            margin-top: 30px;
            position: relative;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
        }

        .progress-bar-inner {
            height: 100%;
            background: var(--primary);
            border-radius: 7px;
            width: 0;
            transition: width 0.4s ease;
            background: linear-gradient(90deg, #4361ee, #7209b7);
        }

        .progress-stage {
            position: absolute;
            top: -30px;
            right: 0;
            font-size: 0.9rem;
            color: var(--text);
            font-weight: 500;
        }

        .download-link {
            display: inline-flex;
            align-items: center;
            margin-top: 25px;
            padding: 15px 30px;
            background: var(--success);
            color: white;
            border-radius: 12px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
            font-size: 1.1rem;
        }

        .download-link:hover {
            background: #388e3c;
            transform: translateY(-3px);
            box-shadow: 0 7px 20px rgba(76, 175, 80, 0.4);
        }

        .download-link i {
            margin-right: 12px;
            font-size: 1.3rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 850px;
            max-height: 90vh;
            overflow: auto;
            padding: 25px;
            position: relative;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.25);
            border: 1px solid #e0e0e0;
        }

        .close-modal {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 1.8rem;
            cursor: pointer;
            color: var(--text-light);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .close-modal:hover {
            background: #f5f5f5;
            color: var(--danger);
        }

        .modal-header {
            margin-bottom: 25px;
            border-bottom: 2px solid var(--gray);
            padding-bottom: 20px;
        }

        .modal-header h2 {
            margin-bottom: 0;
            font-size: 1.8rem;
        }

        .error-modal {
            background: rgba(230, 57, 70, 0.08);
            border-left: 5px solid var(--danger);
        }

        .platform-tips {
            background: rgba(67, 97, 238, 0.08);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            font-size: 0.95rem;
            border-left: 4px solid var(--primary);
        }

        .platform-tips h4 {
            margin-bottom: 12px;
            color: var(--primary);
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .platform-tips ul {
            padding-left: 25px;
        }

        .platform-tips li {
            margin-bottom: 10px;
            line-height: 1.6;
        }

        .cover-preview-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
            padding: 20px;
            background: #f9faff;
            border-radius: 12px;
            border: 1px dashed #4361ee;
        }

        .cover-preview-container img {
            max-width: 250px;
            max-height: 350px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .cover-preview-container h3 {
            color: var(--primary);
            font-size: 1.3rem;
        }

        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            backdrop-filter: blur(5px);
        }

        .spinner {
            border: 5px solid rgba(67, 97, 238, 0.3);
            border-radius: 50%;
            border-top: 5px solid var(--primary);
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #loading-message {
            font-size: 1.2rem;
            color: var(--text);
            text-align: center;
            max-width: 80%;
        }

        #retry-btn {
            margin-top: 20px;
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: none;
        }

        #retry-btn:hover {
            background: var(--primary-light);
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }

            .step-text {
                font-size: 0.75rem;
            }

            .level-controls {
                grid-template-columns: 1fr;
            }

            .btn-container {
                flex-direction: column;
            }

            .btn-container .btn {
                width: 100%;
                margin-bottom: 10px;
                justify-content: center;
            }

            header {
                padding: 20px 15px;
            }
            
            header h1 {
                font-size: 1.6rem;
            }
            
            .content-section {
                padding: 20px;
            }
            
            .modal-content {
                width: 95%;
                padding: 15px;
            }
            
            .file-upload {
                padding: 25px 15px;
            }
            
            .btn {
                padding: 12px 20px;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <div id="loading-overlay">
        <div class="spinner"></div>
        <div id="loading-message">Ê≠£Âú®Âä†ËΩΩÂøÖË¶ÅÁªÑ‰ª∂ÔºåËØ∑Á®çÂÄô...</div>
        <button id="retry-btn">ÈáçËØïÂä†ËΩΩ</button>
    </div>

    <div class="container">
        <header>
            <h1><i class="fas fa-book"></i> TXT ËΩ¨ EPUB ËΩ¨Êç¢Â∑•ÂÖ∑</h1>
            <p>ÊîØÊåÅÊú¨Âú∞ËøêË°åÔºåÊó†ÈúÄÊúçÂä°Âô® | ÂìçÂ∫îÂºèËÆæËÆ° | Ëá™ÂÆö‰πâÁ´†ËäÇÂ±ÇÁ∫ß | ÂÆûÊó∂È¢ÑËßà | iOS‰ºòÂåñ</p>
        </header>

        <div class="progress-steps">
            <div class="progress-bar" style="width: 0%"></div>
            <div class="step active" data-step="1">
                <div class="step-icon">1</div>
                <span class="step-text">‰∏ä‰º†Êñá‰ª∂</span>
            </div>
            <div class="step" data-step="2">
                <div class="step-icon">2</div>
                <span class="step-text">ÂÖÉÊï∞ÊçÆ</span>
            </div>
            <div class="step" data-step="3">
                <div class="step-icon">3</div>
                <span class="step-text">Á´†ËäÇËßÑÂàô</span>
            </div>
            <div class="step" data-step="4">
                <div class="step-icon">4</div>
                <span class="step-text">Â∞ÅÈù¢ËÆæÁΩÆ</span>
            </div>
            <div class="step" data-step="5">
                <div class="step-icon">5</div>
                <span class="step-text">ÁîüÊàê EPUB</span>
            </div>
        </div>

        <!-- ‰∏ä‰º†Êñá‰ª∂Âå∫Âüü -->
        <section id="step-1" class="content-section active">
            <h2><i class="fas fa-file-upload"></i> ‰∏ä‰º† TXT Êñá‰ª∂</h2>
            
            <div class="control-group">
                <div class="file-upload">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <h3>ÊãñÊîæÊñá‰ª∂Âà∞Ê≠§Âå∫ÂüüÊàñÁÇπÂáª‰∏ä‰º†</h3>
                    <p>ÊîØÊåÅ‰ªª‰ΩïÊñáÊú¨ÁºñÁ†ÅÊ†ºÂºèÔºåËá™Âä®ËØÜÂà´ UTF-8„ÄÅASCII Á≠âÂ∏∏ËßÅÁºñÁ†Å</p>
                    <div class="upload-btn">ÈÄâÊã© TXT Êñá‰ª∂</div>
                    <input type="file" id="txt-file" accept=".txt">
                </div>
                
                <div id="file-info" style="display: none;" class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        <strong>Â∑≤ÊàêÂäü‰∏ä‰º†Êñá‰ª∂:</strong> 
                        <span id="filename"></span>
                        <div id="encoding-info"></div>
                    </div>
                </div>
            </div>
            
            <div class="btn-container">
                <div></div>
                <button class="btn btn-primary" onclick="nextStep(2)">‰∏ã‰∏ÄÊ≠• <i class="fas fa-arrow-right"></i></button>
            </div>
        </section>

        <!-- ÂÖÉÊï∞ÊçÆËÆæÁΩÆÂå∫Âüü -->
        <section id="step-2" class="content-section">
            <h2><i class="fas fa-file-alt"></i> ÂÖÉÊï∞ÊçÆËÆæÁΩÆ</h2>
            
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <div>
                    <strong>ÂÖÉÊï∞ÊçÆËØ¥Êòé</strong> 
                    <p>Ëøô‰∫õ‰ø°ÊÅØÂ∞ÜÂµåÂÖ•Âà∞ EPUB Êñá‰ª∂‰∏≠ÔºåÂ∏ÆÂä©ËØÜÂà´‰π¶Á±çÂÜÖÂÆπÂíå‰ΩúËÄÖ</p>
                </div>
            </div>
            
            <div class="form-grid">
                <div class="control-group">
                    <h3><i class="fas fa-tag"></i> Âü∫Á°Ä‰ø°ÊÅØ</h3>
                    <label for="epub-title">Ê†áÈ¢ò</label>
                    <input type="text" id="epub-title" placeholder="ËæìÂÖ•‰π¶Á±çÊ†áÈ¢ò">
                    
                    <label for="epub-author">‰ΩúËÄÖ</label>
                    <input type="text" id="epub-author" placeholder="ËæìÂÖ•‰ΩúËÄÖÂßìÂêç">
                    
                    <label for="epub-filename">ËæìÂá∫Êñá‰ª∂Âêç</label>
                    <input type="text" id="epub-filename" placeholder="Ëá™ÂÆö‰πâ EPUB Êñá‰ª∂Âêç">
                </div>
                
                <div class="control-group">
                    <h3><i class="fas fa-align-left"></i> ÊèèËø∞‰ø°ÊÅØ</h3>
                    <label for="epub-description">ÂÜÖÂÆπÊèèËø∞</label>
                    <textarea id="epub-description" rows="4" placeholder="ËæìÂÖ•‰π¶Á±çÁÆÄ‰ªã..."></textarea>
                    
                    <label for="epub-language">ËØ≠Ë®Ä</label>
                    <input type="text" id="epub-language" value="zh-CN">
                    
                    <label for="epub-publisher">Âá∫ÁâàÂïÜ</label>
                    <input type="text" id="epub-publisher" placeholder="Âá∫ÁâàÂïÜÂêçÁß∞">
                </div>
            </div>
            
            <div class="btn-container">
                <button class="btn btn-outline" onclick="prevStep(1)"><i class="fas fa-arrow-left"></i> ‰∏ä‰∏ÄÊ≠•</button>
                <button class="btn btn-primary" onclick="nextStep(3)">‰∏ã‰∏ÄÊ≠• <i class="fas fa-arrow-right"></i></button>
            </div>
        </section>

        <!-- Á´†ËäÇËßÑÂàôÈÖçÁΩÆÂå∫Âüü -->
        <section id="step-3" class="content-section">
            <h2><i class="fas fa-sitemap"></i> Á´†ËäÇÂ±ÇÁ∫ßÈÖçÁΩÆ</h2>
            
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <div>
                    <strong>ÈÖçÁΩÆËØ¥Êòé</strong> 
                    <p>Â∞èËØ¥Âª∫ËÆÆ‰ΩøÁî®‰∏§Á∫ßÁªìÊûÑÔºàÂç∑+Á´†ÔºâÔºåÊäÄÊúØÊñáÊ°£ÂèØÂêØÁî®‰∏âÁ∫ßÁªìÊûÑ</p>
                </div>
            </div>
            
            <div class="hierarchy-rules">
                <div class="level-group">
                    <div class="level-header">
                        <i class="fas fa-layer-group"></i> Á¨¨1Â±ÇÁ∫ß (Âç∑/ÈÉ®)
                    </div>
                    <div class="level-controls">
                        <div>
                            <label for="l1-prefix">ÂâçÁºÄ</label>
                            <input type="text" id="l1-prefix" placeholder="‰æãÂ¶Ç: Á¨¨, ‚àö, Chap">
                        </div>
                        <div>
                            <label for="l1-suffix">ÂêéÁºÄ</label>
                            <input type="text" id="l1-suffix" placeholder="‰æãÂ¶Ç: Âç∑|ÈÉ®">
                        </div>
                        <div>
                            <label for="l1-separator">ÂàÜÈöîÁ¨¶</label>
                            <input type="text" id="l1-separator" placeholder="‰æãÂ¶Ç: Á©∫Ê†ºÊàñÁÇπ">
                        </div>
                        <div>
                            <label for="l1-numtype">Êï∞Â≠óÁ±ªÂûã</label>
                            <select id="l1-numtype">
                                <option value="chinese">‰∏≠ÊñáÊï∞Â≠ó</option>
                                <option value="arabic">ÈòøÊãâ‰ºØÊï∞Â≠ó</option>
                                <option value="both" selected>Ê∑∑ÂêàËØÜÂà´</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="level-group">
                    <div class="level-header">
                        <i class="fas fa-layer-group"></i> Á¨¨2Â±ÇÁ∫ß (Á´†/Âõû)
                    </div>
                    <div class="level-controls">
                        <div>
                            <label for="l2-prefix">ÂâçÁºÄ</label>
                            <input type="text" id="l2-prefix" value="Á¨¨" placeholder="‰æãÂ¶Ç: Á¨¨">
                        </div>
                        <div>
                            <label for="l2-suffix">ÂêéÁºÄ</label>
                            <input type="text" id="l2-suffix" value="Á´†|Á´†Âõû" placeholder="‰æãÂ¶Ç: Á´†|Á´†Âõû">
                        </div>
                        <div>
                            <label for="l2-separator">ÂàÜÈöîÁ¨¶</label>
                            <input type="text" id="l2-separator" value=" " placeholder="‰æãÂ¶Ç: Á©∫Ê†º">
                        </div>
                        <div>
                            <label for="l2-numtype">Êï∞Â≠óÁ±ªÂûã</label>
                            <select id="l2-numtype">
                                <option value="chinese">‰∏≠ÊñáÊï∞Â≠ó</option>
                                <option value="arabic" selected>ÈòøÊãâ‰ºØÊï∞Â≠ó</option>
                                <option value="both">Ê∑∑ÂêàËØÜÂà´</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="level-group">
                    <div class="level-header">
                        <i class="fas fa-layer-group"></i> Á¨¨3Â±ÇÁ∫ß (ËäÇ/ÊÆµ)
                        <label class="toggle-switch">
                            <input type="checkbox" id="toggle-level3"> 
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div id="level3-controls" style="display:none;">
                        <div class="level-controls">
                            <div>
                                <label for="l3-prefix">ÂâçÁºÄ</label>
                                <input type="text" id="l3-prefix" placeholder="‰æãÂ¶Ç: ‚úÖ, ‚òÖ">
                            </div>
                            <div>
                                <label for="l3-suffix">ÂêéÁºÄ</label>
                                <input type="text" id="l3-suffix" placeholder="‰æãÂ¶Ç: ËäÇ|ÊÆµ">
                            </div>
                            <div>
                                <label for="l3-separator">ÂàÜÈöîÁ¨¶</label>
                                <input type="text" id="l3-separator" value=". " placeholder="‰æãÂ¶Ç: .">
                            </div>
                            <div>
                                <label for="l3-numtype">Êï∞Â≠óÁ±ªÂûã</label>
                                <select id="l3-numtype">
                                    <option value="chinese">‰∏≠ÊñáÊï∞Â≠ó</option>
                                    <option value="arabic" selected>ÈòøÊãâ‰ºØÊï∞Â≠ó</option>
                                    <option value="both">Ê∑∑ÂêàËØÜÂà´</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Á´†ËäÇËØÜÂà´ÂèÇÊï∞ÈÖçÁΩÆ -->
            <div class="form-grid">
                <div class="control-group">
                    <h3><i class="fas fa-cog"></i> Á´†ËäÇËØÜÂà´ÂèÇÊï∞</h3>
                    
                    <label for="max-title-length">ÊúÄÂ§ßÊ†áÈ¢òÈïøÂ∫¶</label>
                    <input type="number" id="max-title-length" value="50" min="20" max="100">
                    <p style="font-size: 0.9rem; color: var(--text-light); margin-top: 5px;">
                        Ë∂ÖËøáÊ≠§ÈïøÂ∫¶ÁöÑË°å‰∏ç‰ºöË¢´ËØÜÂà´‰∏∫Á´†ËäÇÊ†áÈ¢ò
                    </p>
                    
                    <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                        <div>
                            <label for="min-gap-before">Ê†áÈ¢òÂâçÊúÄÂ∞èÁ©∫Ë°åÊï∞</label>
                            <input type="number" id="min-gap-before" value="0" min="0" max="5">
                            <p style="font-size: 0.9rem; color: var(--text-light); margin-top: 5px;">
                                0=‰∏çË¶ÅÊ±ÇÁ©∫Ë°å
                            </p>
                        </div>
                        <div>
                            <label for="min-gap-after">Ê†áÈ¢òÂêéÊúÄÂ∞èÁ©∫Ë°åÊï∞</label>
                            <input type="number" id="min-gap-after" value="0" min="0" max="5">
                            <p style="font-size: 0.9rem; color: var(--text-light); margin-top: 5px;">
                                0=‰∏çË¶ÅÊ±ÇÁ©∫Ë°å
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="btn-container">
                <button class="btn btn-outline" onclick="prevStep(2)"><i class="fas fa-arrow-left"></i> ‰∏ä‰∏ÄÊ≠•</button>
                <button class="btn btn-primary" onclick="showChapterPreview()">È¢ÑËßàÁ´†ËäÇÁªìÊûÑ</button>
                <button class="btn btn-primary" onclick="nextStep(4)">‰∏ã‰∏ÄÊ≠• <i class="fas fa-arrow-right"></i></button>
            </div>
        </section>

        <!-- Â∞ÅÈù¢ËÆæÁΩÆÂå∫Âüü -->
        <section id="step-4" class="content-section">
            <h2><i class="fas fa-image"></i> Â∞ÅÈù¢ËÆæÁΩÆ</h2>
            
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <div>
                    <strong>Â∞ÅÈù¢ËØ¥Êòé</strong> 
                    <p>Â∞ÅÈù¢ÂõæÁâáÂ∞Ü‰Ωú‰∏∫ EPUB Êñá‰ª∂ÁöÑÂ∞ÅÈù¢ÊòæÁ§∫</p>
                </div>
            </div>
            
            <div class="form-grid">
                <div class="control-group">
                    <h3><i class="fas fa-book-cover"></i> Â∞ÅÈù¢ÂõæÁâá</h3>
                    <label for="cover-file">‰∏ä‰º†Â∞ÅÈù¢</label>
                    <input type="file" id="cover-file" accept=".jpg,.jpeg,.png">
                    <p style="font-size: 0.95rem; color: var(--text-light); margin-top: 8px;">
                        ÊîØÊåÅ JPG Êàñ PNG Ê†ºÂºèÔºåÂª∫ËÆÆÂ∞∫ÂØ∏Ôºö600√ó800ÂÉèÁ¥†
                    </p>
                    
                    <div id="cover-preview" class="cover-preview-container" style="display: none;">
                        <h3><i class="fas fa-image"></i> Â∞ÅÈù¢È¢ÑËßà</h3>
                        <img id="cover-image" src="" alt="Â∞ÅÈù¢È¢ÑËßà">
                        <p id="cover-filename" style="color: var(--text-light); margin-top: 10px;"></p>
                    </div>
                </div>
            </div>
            
            <div class="btn-container">
                <button class="btn btn-outline" onclick="prevStep(3)"><i class="fas fa-arrow-left"></i> ‰∏ä‰∏ÄÊ≠•</button>
                <button class="btn btn-primary" onclick="nextStep(5)">ÁîüÊàê EPUB <i class="fas fa-book"></i></button>
            </div>
        </section>

        <!-- ÁîüÊàêËøõÂ∫¶Âå∫Âüü -->
        <section id="step-5" class="content-section">
            <h2><i class="fas fa-cogs"></i> ÁîüÊàê EPUB Êñá‰ª∂</h2>
            
            <div id="convert-info" class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <div>
                    <strong>ÂáÜÂ§áÁîüÊàê EPUB</strong> 
                    <p>Â∞ÜÊ†πÊçÆÊÇ®ÁöÑËÆæÁΩÆÁîüÊàê EPUB ÁîµÂ≠ê‰π¶Êñá‰ª∂</p>
                </div>
            </div>
            
            <div class="control-group">
                <h3><i class="fas fa-book"></i> ËæìÂá∫‰ø°ÊÅØ</h3>
                <div class="form-grid">
                    <div>
                        <label>Ê†áÈ¢ò</label>
                        <input type="text" id="output-title" disabled>
                    </div>
                    <div>
                        <label>‰ΩúËÄÖ</label>
                        <input type="text" id="output-author" disabled>
                    </div>
                    <div>
                        <label>Êñá‰ª∂Âêç</label>
                        <input type="text" id="output-filename" disabled>
                    </div>
                    <div>
                        <label>Á´†ËäÇÊï∞Èáè</label>
                        <input type="text" id="output-chapters" disabled>
                    </div>
                </div>
            </div>
            
            <div class="progress-container">
                <div id="progress-bar" class="progress-bar-inner"></div>
                <div id="progress-stage" class="progress-stage">ÂáÜÂ§á‰∏≠...</div>
            </div>
            
            <div id="download-section" style="display:none; text-align:center; margin-top:25px;">
                <h3>EPUB Êñá‰ª∂Â∑≤ÁîüÊàê</h3>
                <button id="download-btn" class="download-link">
                    <i class="fas fa-download"></i> ‰∏ãËΩΩ EPUB Êñá‰ª∂
                </button>
                <div class="platform-tips">
                    <h4><i class="fas fa-info-circle"></i> Âπ≥Âè∞‰∏ãËΩΩÊèêÁ§∫</h4>
                    <ul>
                        <li><strong>iOS Áî®Êà∑</strong>: ÁÇπÂáª‰∏ãËΩΩÊåâÈíÆÂêéÔºåÂú®SafariËèúÂçï‰∏≠ÈÄâÊã©"‰∏ãËΩΩÈìæÊé•Êñá‰ª∂"ÔºåÁÑ∂Âêé‰øùÂ≠òÂà∞"Êñá‰ª∂"Â∫îÁî®</li>
                        <li><strong>Android Áî®Êà∑</strong>: Êñá‰ª∂Â∞Ü‰øùÂ≠òÂà∞ÈªòËÆ§‰∏ãËΩΩÁõÆÂΩïÔºåÂèØÂú®"Êñá‰ª∂ÁÆ°ÁêÜ"‰∏≠ÊâæÂà∞</li>
                        <li><strong>Windows Áî®Êà∑</strong>: Êñá‰ª∂Â∞Ü‰øùÂ≠òÂà∞ÊµèËßàÂô®ÈªòËÆ§‰∏ãËΩΩ‰ΩçÁΩÆ</li>
                    </ul>
                </div>
            </div>
            
            <div class="btn-container">
                <button class="btn btn-outline" onclick="prevStep(4)"><i class="fas fa-arrow-left"></i> ‰∏ä‰∏ÄÊ≠•</button>
                <button id="convert-btn" class="btn btn-success" onclick="convertToEpub()">ÂºÄÂßãËΩ¨Êç¢ <i class="fas fa-magic"></i></button>
            </div>
        </section>
    </div>

    <!-- Á´†ËäÇÈ¢ÑËßàÊ®°ÊÄÅÊ°Ü -->
    <div id="chapter-preview-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <div class="modal-header">
                <h2><i class="fas fa-eye"></i> Á´†ËäÇËØÜÂà´È¢ÑËßà</h2>
            </div>
            
            <div id="preview-alert" class="alert alert-success">
                <i class="fas fa-check-circle"></i>
                <div>
                    <strong>ËØÜÂà´ÊàêÂäü!</strong> 
                    ÂÖ±Ê£ÄÊµãÂà∞ <span id="chapter-count">0</span> ‰∏™Á´†ËäÇ
                </div>
            </div>
            
            <div id="preview-container" class="chapter-preview">
                <!-- Âä®ÊÄÅÁîüÊàêÈ¢ÑËßàÂÜÖÂÆπ -->
            </div>
            
            <div class="btn-container" style="margin-top: 20px;">
                <button class="btn btn-outline" onclick="closeModal()">ÂÖ≥Èó≠È¢ÑËßà</button>
                <button class="btn btn-primary" onclick="applyPreviewChanges()">Â∫îÁî®ËÆæÁΩÆ</button>
            </div>
        </div>
    </div>

    <!-- ÈîôËØØÊèêÁ§∫Ê®°ÊÄÅÊ°Ü -->
    <div id="error-modal" class="modal">
        <div class="modal-content error-modal">
            <span class="close-modal" onclick="closeErrorModal()">&times;</span>
            <div class="modal-header">
                <h2><i class="fas fa-exclamation-triangle"></i> ËΩ¨Êç¢Â§±Ë¥•</h2>
            </div>
            
            <div id="error-content" style="padding: 20px; font-size: 1.1rem;">
                <!-- ÈîôËØØÂÜÖÂÆπÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
            </div>
            
            <div class="btn-container" style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="closeErrorModal()">ÂÖ≥Èó≠</button>
            </div>
        </div>
    </div>

    <script>
        // Âä®ÊÄÅÂä†ËΩΩJSZipÂíåFileSaver.js
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }
        
        // Ê£ÄÊµãÊòØÂê¶iOSÁ≥ªÁªü
        function isIOS() {
            return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        }
        
        // Ê£ÄÊµãÊòØÂê¶Âú®Êú¨Âú∞Êñá‰ª∂ÁéØÂ¢É‰∏≠
        function isLocalEnvironment() {
            return window.location.protocol === 'file:';
        }
        
        // Âä†ËΩΩÂøÖË¶ÅÁöÑÂ∫ì
        async function loadLibraries() {
            const loadingOverlay = document.getElementById('loading-overlay');
            const loadingMessage = document.getElementById('loading-message');
            const retryBtn = document.getElementById('retry-btn');
            
            try {
                // Â∞ùËØïÂä†ËΩΩJSZipÂíåFileSaver
                loadingMessage.textContent = 'Ê≠£Âú®Âä†ËΩΩJSZipÂ∫ì...';
                await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js');
                
                loadingMessage.textContent = 'Ê≠£Âú®Âä†ËΩΩFileSaverÂ∫ì...';
                await loadScript('https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js');
                
                // Ê£ÄÊü•Â∫ìÊòØÂê¶Âä†ËΩΩÊàêÂäü
                if (typeof JSZip === 'undefined' || typeof saveAs === 'undefined') {
                    throw new Error('Ê†∏ÂøÉÂ∫ìÊú™Ê≠£Á°ÆÂä†ËΩΩ');
                }
                
                // ÈöêËóèÂä†ËΩΩÁïåÈù¢
                loadingOverlay.style.display = 'none';
                
                // ÂàùÂßãÂåñÂ∑•ÂÖ∑
                initTool();
            } catch (error) {
                console.error('Â∫ìÂä†ËΩΩÂ§±Ë¥•:', error);
                loadingMessage.innerHTML = `Âä†ËΩΩÂ§±Ë¥•: ${error.message}<br>ËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÂêéÈáçËØï`;
                retryBtn.style.display = 'block';
            }
        }
        
        // ÈáçËØïÂä†ËΩΩ
        document.getElementById('retry-btn').addEventListener('click', loadLibraries);
        
        // ËøõÂ∫¶ÁÆ°ÁêÜÂíåÊ≠•È™§ÊéßÂà∂
        let currentStep = 1;
        let txtContent = "";
        let chapters = [];
        let currentBook = null;
        let coverImageFile = null;
        let coverImageType = "";
        let generatedEpubBlob = null;
        let epubFileName = "";
        
        function nextStep(step) {
            document.querySelector(`#step-${currentStep}`).classList.remove('active');
            document.querySelector(`.step[data-step="${currentStep}"]`).classList.remove('active');
            
            currentStep = step;
            
            document.querySelector(`#step-${currentStep}`).classList.add('active');
            document.querySelector(`.step[data-step="${currentStep}"]`).classList.add('active');
            
            // Êõ¥Êñ∞ËøõÂ∫¶Êù°
            const progress = Math.round((currentStep - 1) * (100 / 4));
            document.querySelector('.progress-bar').style.width = `${progress}%`;
        }
        
        function prevStep(step) {
            nextStep(step);
        }
        
        // ÊâìÂºÄÁ´†ËäÇÈ¢ÑËßàÊ®°ÊÄÅÊ°Ü
        function showChapterPreview() {
            // ËØÜÂà´Á´†ËäÇ
            identifyChapters();
            
            // Êõ¥Êñ∞UI
            document.getElementById('preview-alert').style.display = 'flex';
            document.getElementById('chapter-count').textContent = chapters.length;
            
            // Ê∏≤ÊüìÈ¢ÑËßà
            const previewContainer = document.getElementById('preview-container');
            previewContainer.innerHTML = '';
            
            // ÈôêÂà∂È¢ÑËßàÊï∞Èáè
            const maxPreview = 20;
            const previewChapters = chapters.slice(0, maxPreview);
            
            // Âä®ÁîªÊïàÊûú
            let delay = 0;
            previewChapters.forEach(chapter => {
                setTimeout(() => {
                    const item = document.createElement('div');
                    item.className = `chapter-item level-${chapter.level} ${chapter.valid ? '' : 'invalid'}`;
                    item.innerHTML = `
                        <span class="chapter-label">[${chapter.level}Á∫ß]</span> <span>${chapter.title}</span>
                        <span style="float: right; color: var(--text-light);">Á¨¨${chapter.line}Ë°å</span>
                    `;
                    previewContainer.appendChild(item);
                    item.style.opacity = '0';
                    item.style.transform = 'translateY(10px)';
                    
                    setTimeout(() => {
                        item.style.transition = 'all 0.3s ease';
                        item.style.opacity = '1';
                        item.style.transform = 'translateY(0)';
                    }, 10);
                }, delay);
                
                delay += 80;
            });
            
            // ÊòæÁ§∫Êõ¥Â§öÈÄâÈ°π
            if (chapters.length > maxPreview) {
                const moreItem = document.createElement('div');
                moreItem.className = 'chapter-item';
                moreItem.innerHTML = `
                    <span class="chapter-label">[...]</span>
                    <span>ËøòÊúâ ${chapters.length - maxPreview} ‰∏™Á´†ËäÇÊú™ÊòæÁ§∫</span>
                `;
                previewContainer.appendChild(moreItem);
            }
            
            // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
            document.getElementById('chapter-preview-modal').style.display = 'flex';
        }
        
        // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
        function closeModal() {
            document.getElementById('chapter-preview-modal').style.display = 'none';
        }
        
        // Â∫îÁî®È¢ÑËßàËÆæÁΩÆ
        function applyPreviewChanges() {
            closeModal();
            nextStep(4);
        }
        
        // ÂÖ≥Èó≠ÈîôËØØÊ®°ÊÄÅÊ°Ü
        function closeErrorModal() {
            document.getElementById('error-modal').style.display = 'none';
        }
        
        // ÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ
        function showError(title, message, solution) {
            const errorContent = document.getElementById('error-content');
            errorContent.innerHTML = `
                <h3 style="color: var(--danger); margin-bottom: 15px;">${title}</h3>
                <p style="margin-bottom: 20px;">${message}</p>
                <div class="alert alert-info" style="margin-top: 20px;">
                    <i class="fas fa-lightbulb"></i>
                    <div>
                        <strong>Ëß£ÂÜ≥ÊñπÊ°à</strong> 
                        <p>${solution}</p>
                    </div>
                </div>
            `;
            document.getElementById('error-modal').style.display = 'flex';
        }

        // ‰∏âÁ∫ßÁªìÊûÑÂºÄÂÖ≥ÊéßÂà∂
        document.getElementById('toggle-level3').addEventListener('change', function() {
            const level3Controls = document.getElementById('level3-controls');
            if (this.checked) {
                level3Controls.style.display = 'block';
            } else {
                level3Controls.style.display = 'none';
            }
        });

        // Êñá‰ª∂‰∏ä‰º†Â§ÑÁêÜ
        const fileInput = document.getElementById('txt-file');
        const filenameSpan = document.getElementById('filename');
        const encodingInfo = document.getElementById('encoding-info');
        const fileInfoDiv = document.getElementById('file-info');
        
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // Êô∫ËÉΩËß£ÊûêÊñá‰ª∂Âêç - ‰ºòÂÖàËß£Êûê‰π¶ÂêçÂè∑Ê†ºÂºè
                const fileName = file.name;
                let bookTitle = fileName.replace('.txt', '');
                let authorName = '';
                
                // Êñ∞ÈÄªËæëÔºö‰ºòÂÖàËØÜÂà´„Ää‰π¶Âêç„ÄãÊ†ºÂºè
                const pattern1 = /„Ää(.+?)„Äã/;  // ÂåπÈÖç„Ää‰π¶Âêç„ÄãÊ†ºÂºè
                const match1 = fileName.match(pattern1);
                
                // ÊóßÊ®°ÂºèÔºö‰π¶Âêç„Äã‰ΩúËÄÖÔºö‰ΩúËÄÖÂêç
                const pattern2 = /„Ää(.+?)„Äã\s*‰ΩúËÄÖ[:Ôºö]\s*(.+)/;
                const match2 = fileName.match(pattern2);
                
                if (match1) {
                    bookTitle = match1[1];
                    authorName = fileName.replace(match1[0], '')     // ÁßªÈô§‰π¶ÂêçÂè∑ÈÉ®ÂàÜ
                                        .replace('.txt', '')        // ÁßªÈô§Êñá‰ª∂Êâ©Â±ïÂêç
                                        .replace(/^\s+|\s+$/g, '')  // ÁßªÈô§È¶ñÂ∞æÁ©∫Ê†º
                                        .replace(/^[-_]\s*|\s*[-_]$/g, ''); // ÁßªÈô§È¶ñÂ∞æËøûÊé•Á¨¶
                } else if (match2) {
                    bookTitle = match2[1];
                    authorName = match2[2].replace('.txt', '');
                } else {
                    bookTitle = fileName.replace('.txt', '');
                }
                
                // Â°´ÂÖÖÂà∞Ë°®Âçï
                document.getElementById('epub-title').value = bookTitle;
                document.getElementById('epub-author').value = authorName;
                document.getElementById('epub-filename').value = bookTitle;
                
                // ÊòæÁ§∫Êñá‰ª∂‰ø°ÊÅØ
                filenameSpan.textContent = file.name;
                fileInfoDiv.style.display = 'flex';
                
                // Â∞ùËØïËØÜÂà´ÁºñÁ†ÅÂπ∂ËØªÂèñÊñá‰ª∂ÔºàÊîØÊåÅUTF-8„ÄÅUTF-16LE„ÄÅGBKÔºâ
                const reader = new FileReader();
                reader.onload = function(event) {
                    const buffer = event.target.result;
                    let encoding = null;
                    let content = "";

                    // Ëß£Á†ÅÂ∞ùËØïÈ°∫Â∫èÔºöUTF-8 ‚Üí UTF-16LE ‚Üí GBK
                    const decoders = [
                        { name: 'UTF-8', decoder: new TextDecoder('utf-8', { fatal: true }) },
                        { name: 'UTF-16LE', decoder: new TextDecoder('utf-16le', { fatal: true }) }, // Êñ∞Â¢ûUTF-16LEÊîØÊåÅ
                        { name: 'GBK', decoder: new TextDecoder('gbk', { fatal: true }) }
                    ];

                    for (const { name, decoder } of decoders) {
                        try {
                            content = decoder.decode(buffer);
                            encoding = name;
                            break; // Ëß£Á†ÅÊàêÂäüÂàôË∑≥Âá∫Âæ™ÁéØ
                        } catch (e) {
                            continue; // Ëß£Á†ÅÂ§±Ë¥•ÂàôÂ∞ùËØï‰∏ã‰∏ÄÁßçÁºñÁ†Å
                        }
                    }

                    if (encoding) {
                        txtContent = content;
                        encodingInfo.innerHTML = `ÁºñÁ†Å: <strong>${encoding}</strong> | Â∑≤ÊàêÂäüËß£Á†Å`;
                    } else {
                        // ÊâÄÊúâÁºñÁ†ÅÂ∞ùËØïÂ§±Ë¥•Êó∂
                        txtContent = "";
                        encodingInfo.innerHTML = "ÁºñÁ†Å: <strong>Êó†Ê≥ïËØÜÂà´</strong> | ËØ∑Â∞ùËØïÂÖ∂‰ªñÁºñÁ†ÅÊ†ºÂºèÁöÑÊñá‰ª∂";
                    }
                };
                reader.readAsArrayBuffer(file);
            }
        });
        
        // Â∞ÅÈù¢È¢ÑËßà
        const coverFileInput = document.getElementById('cover-file');
        coverFileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const coverPreview = document.getElementById('cover-preview');
                    const coverImage = document.getElementById('cover-image');
                    const coverFilename = document.getElementById('cover-filename');
                    
                    coverImage.src = event.target.result;
                    coverFilename.textContent = file.name;
                    coverPreview.style.display = 'flex';
                    
                    // ‰øùÂ≠òÂ∞ÅÈù¢Êñá‰ª∂‰ø°ÊÅØ
                    coverImageFile = file;
                    coverImageType = file.type;
                };
                reader.readAsDataURL(file);
            }
        });
        
        // ÊãñÊîæÊñá‰ª∂ÊîØÊåÅ
        const uploadSection = document.querySelector('.file-upload');
        uploadSection.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.style.borderColor = '#4361ee';
            this.style.backgroundColor = 'rgba(67, 97, 238, 0.1)';
        });
        
        uploadSection.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.style.borderColor = '';
            this.style.backgroundColor = '';
        });
        
        uploadSection.addEventListener('drop', function(e) {
            e.preventDefault();
            this.style.borderColor = '';
            this.style.backgroundColor = '';
            
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                const event = new Event('change', { bubbles: true });
                fileInput.dispatchEvent(event);
            }
        });
        
        // Á´†ËäÇËØÜÂà´ÈÄªËæëÔºàÊ†∏ÂøÉ‰ºòÂåñÔºâ - ‰øÆÊîπÁÇπÔºö‰ΩøÁî®Êï¥Ë°å‰Ωú‰∏∫Ê†áÈ¢ò
        function identifyChapters() {
            if (!txtContent) {
                showError("ÂÜÖÂÆπ‰∏∫Á©∫", "Êú™Ê£ÄÊµãÂà∞ÊúâÊïàÁöÑÊñáÊú¨ÂÜÖÂÆπ", "ËØ∑Á°Æ‰øùÂ∑≤‰∏ä‰º†ÊúâÊïàÁöÑTXTÊñá‰ª∂Âπ∂ÂåÖÂê´Á´†ËäÇÂÜÖÂÆπ");
                return [];
            }
            
            const lines = txtContent.split('\n');
            chapters = [];
            const level3Enabled = document.getElementById('toggle-level3').checked;
            
            // Ëé∑ÂèñÁî®Êà∑ÈÖçÁΩÆ
            const l1Prefix = document.getElementById('l1-prefix').value || '';
            const l1Suffix = document.getElementById('l1-suffix').value || '';
            const l1Separator = document.getElementById('l1-separator').value || '';
            const l1NumType = document.getElementById('l1-numtype').value;
            
            const l2Prefix = document.getElementById('l2-prefix').value || '';
            const l2Suffix = document.getElementById('l2-suffix').value || '';
            const l2Separator = document.getElementById('l2-separator').value || '';
            const l2NumType = document.getElementById('l2-numtype').value;
            
            let l3Prefix = '';
            let l3Suffix = '';
            let l3Separator = '';
            let l3NumType = '';
            
            if (level3Enabled) {
                l3Prefix = document.getElementById('l3-prefix').value || '';
                l3Suffix = document.getElementById('l3-suffix').value || '';
                l3Separator = document.getElementById('l3-separator').value || '';
                l3NumType = document.getElementById('l3-numtype').value;
            }
            
            // Ëé∑ÂèñÁ´†ËäÇËØÜÂà´ÂèÇÊï∞
            const maxTitleLength = parseInt(document.getElementById('max-title-length').value) || 50;
            const minGapBefore = parseInt(document.getElementById('min-gap-before').value) || 0;
            const minGapAfter = parseInt(document.getElementById('min-gap-after').value) || 0;
            
            // ÊûÑÂª∫Ê≠£ÂàôË°®ËææÂºèÊ®°Âºè - ÊîØÊåÅÁ∫ØÊï∞Â≠óÁ´†ËäÇ
            const buildPattern = (prefix, suffix, separator, numType) => {
                let pattern = '^';
                
                // Â§ÑÁêÜÂâçÁºÄ - Â¶ÇÊûúÂ≠òÂú®ÂàôÂøÖÈ°ªÂåπÈÖç
                if (prefix) {
                    pattern += `(?:${prefix.replace(/\|/g, '|')})`;
                }
                
                // Â§ÑÁêÜÊï∞Â≠ó
                const chineseNums = 'Èõ∂‰∏Ä‰∫å‰∏âÂõõ‰∫îÂÖ≠‰∏ÉÂÖ´‰πùÂçÅÁôæÂçÉ';
                if (numType === 'chinese') {
                    pattern += `([${chineseNums}]+)`;
                } else if (numType === 'arabic') {
                    pattern += '(\\d+)';
                } else {
                    pattern += `([${chineseNums}\\d]+)`;
                }
                
                // Â§ÑÁêÜÂêéÁºÄ - Â¶ÇÊûúÂ≠òÂú®ÂàôÂøÖÈ°ªÂåπÈÖç
                if (suffix) {
                    pattern += `(?:${suffix.replace(/\|/g, '|')})`;
                }
                
                // Â§ÑÁêÜÂàÜÈöîÁ¨¶
                if (separator) {
                    pattern += `\\s*${separator.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\s*`;
                } else {
                    pattern += '\\s*'; // Â¶ÇÊûúÊ≤°ÊúâÂàÜÈöîÁ¨¶ÔºåÊï∞Â≠óÂíåÊ†áÈ¢ò‰πãÈó¥ÂÖÅËÆ∏ÊúâÁ©∫Ê†º
                }
                
                // Ê†áÈ¢òÈÉ®ÂàÜÊîπ‰∏∫ÂèØÈÄâÔºåÊîØÊåÅÁ∫ØÊï∞Â≠óÁ´†ËäÇ
                pattern += '(.+)?$';
                return new RegExp(pattern);
            };
            
            const level1Pattern = buildPattern(l1Prefix, l1Suffix, l1Separator, l1NumType);
            const level2Pattern = buildPattern(l2Prefix, l2Suffix, l2Separator, l2NumType);
            const level3Pattern = level3Enabled ? 
                buildPattern(l3Prefix, l3Suffix, l3Separator, l3NumType) : null;
            
            // ËØÜÂà´Á´†ËäÇ - ‰øÆÊîπÁÇπÔºö‰ΩøÁî®Êï¥Ë°å‰Ωú‰∏∫Ê†áÈ¢ò
            outer: for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                // Ë∑≥ËøáÁ©∫Ë°å
                if (!line) continue;
                
                // Ê£ÄÊü•Ë°åÈïøÂ∫¶ÈôêÂà∂
                if (line.length > maxTitleLength) continue;
                
                // Ê£ÄÊü•Ê†áÈ¢òÂâçÁ©∫Ë°å
                if (minGapBefore > 0) {
                    for (let j = 1; j <= minGapBefore; j++) {
                        if (i - j >= 0 && lines[i - j].trim() !== '') {
                            continue outer;
                        }
                    }
                }
                
                // Ê£ÄÊü•Ê†áÈ¢òÂêéÁ©∫Ë°å
                if (minGapAfter > 0) {
                    for (let j = 1; j <= minGapAfter; j++) {
                        if (i + j < lines.length && lines[i + j].trim() !== '') {
                            continue outer;
                        }
                    }
                }
                
                // Â∞ùËØïÂåπÈÖç‰∏çÂêåÂ±ÇÁ∫ß - ‰øÆÊîπÁÇπÔºöÁõ¥Êé•‰ΩøÁî®Êï¥Ë°å‰Ωú‰∏∫Ê†áÈ¢ò
                let match;
                if ((match = line.match(level1Pattern))) {
                    chapters.push({
                        level: 1,
                        title: line,  // ‰ΩøÁî®Êï¥Ë°å‰Ωú‰∏∫Ê†áÈ¢ò
                        line: i + 1,
                        valid: true
                    });
                } else if ((match = line.match(level2Pattern))) {
                    chapters.push({
                        level: 2,
                        title: line,  // ‰ΩøÁî®Êï¥Ë°å‰Ωú‰∏∫Ê†áÈ¢ò
                        line: i + 1,
                        valid: true
                    });
                } else if (level3Enabled && (match = line.match(level3Pattern))) {
                    chapters.push({
                        level: 3,
                        title: line,  // ‰ΩøÁî®Êï¥Ë°å‰Ωú‰∏∫Ê†áÈ¢ò
                        line: i + 1,
                        valid: true
                    });
                }
            }
            
            // È™åËØÅÁ´†ËäÇÁªìÊûÑ
            validateChapterStructure();
            
            return chapters;
        }
        
        // Á´†ËäÇÁªìÊûÑÈ™åËØÅ
        function validateChapterStructure() {
            let lastLevel = 0;
            
            for (let i = 0; i < chapters.length; i++) {
                const chapter = chapters[i];
                
                // Ê£ÄÊü•Â±ÇÁ∫ßË∑≥Ë∑ÉÔºà‰æãÂ¶Ç‰ªé1Á∫ßÁõ¥Êé•Âà∞3Á∫ßÔºâ
                if (chapter.level > lastLevel + 1) {
                    chapter.valid = false;
                }
                
                lastLevel = chapter.level;
            }
        }
        
        // ËΩ¨Êç¢EPUBÂäüËÉΩ
        function convertToEpub() {
            // Ê£ÄÊü•Êñá‰ª∂ÊòØÂê¶Â∑≤‰∏ä‰º†
            if (!fileInput.files.length) {
                showError("Êñá‰ª∂Êú™‰∏ä‰º†", "ËØ∑ÂÖà‰∏ä‰º†TXTÊñá‰ª∂", "ËøîÂõûÁ¨¨‰∏ÄÊ≠•‰∏ä‰º†ÊúâÊïàÁöÑTXTÊñá‰ª∂");
                nextStep(1);
                return;
            }
            
            // Ê£ÄÊü•Á´†ËäÇ‰ø°ÊÅØ
            if (chapters.length === 0) {
                showError("Á´†ËäÇËØÜÂà´Â§±Ë¥•", "Êú™Ê£ÄÊµãÂà∞ÊúâÊïàÁöÑÁ´†ËäÇÁªìÊûÑ", "ËØ∑Ë∞ÉÊï¥Á´†ËäÇËßÑÂàôËÆæÁΩÆÊàñËøîÂõûÁ¨¨‰∏âÊ≠•ÈáçÊñ∞ÈÖçÁΩÆ");
                nextStep(3);
                return;
            }
            
            // Êõ¥Êñ∞ËæìÂá∫‰ø°ÊÅØ
            document.getElementById('output-title').value = document.getElementById('epub-title').value;
            document.getElementById('output-author').value = document.getElementById('epub-author').value;
            epubFileName = document.getElementById('epub-filename').value + '.epub';
            document.getElementById('output-filename').value = epubFileName;
            document.getElementById('output-chapters').value = chapters.length + ' Á´†';
            
            // ÂºÄÂßãËΩ¨Êç¢
            generateEpubFile();
        }
        
        // Êñá‰ª∂ÂêçÂÆâÂÖ®ËøáÊª§
        function sanitizeFilename(name) {
            return name.replace(/[\\/:*?"<>|]/g, '');
        }
        
        // Êõ¥Êñ∞ËøõÂ∫¶Êù°
        function updateProgress(percent, stage) {
            const progressBar = document.getElementById('progress-bar');
            const progressStage = document.getElementById('progress-stage');
            
            progressBar.style.width = `${percent}%`;
            progressStage.textContent = stage;
        }
        
        // ÊûÑÂª∫Á´†ËäÇÊ†ëÁªìÊûÑÔºà‰øÆÂ§çÁõÆÂΩïÈóÆÈ¢òÔºâ
        function buildChapterTree() {
            const tree = [];
            const stack = [];
            let idCounter = 0;
            
            for (const chapter of chapters) {
                if (!chapter.valid) continue;
                
                // ÂàõÂª∫ËäÇÁÇπ
                const node = {
                    id: `chapter-${++idCounter}`,
                    level: chapter.level,
                    title: chapter.title,
                    line: chapter.line,
                    children: []
                };
                
                // ÂØªÊâæÂêàÈÄÇÁöÑÁà∂ËäÇÁÇπ
                while (stack.length > 0 && stack[stack.length - 1].level >= node.level) {
                    stack.pop();
                }
                
                if (stack.length === 0) {
                    // Ê†πËäÇÁÇπ
                    tree.push(node);
                } else {
                    // Ê∑ªÂä†Âà∞Áà∂ËäÇÁÇπÁöÑchildren
                    stack[stack.length - 1].children.push(node);
                }
                
                // Â∞ÜÂΩìÂâçËäÇÁÇπÂéãÂÖ•Ê†à
                stack.push(node);
            }
            
            return tree;
        }
        
        // EPUBÊñá‰ª∂ÁîüÊàêÊ†∏ÂøÉÈÄªËæëÔºà‰øÆÂ§çÁâàÔºâ
        function generateEpubFile() {
            const title = document.getElementById('epub-title').value || 'Êú™ÂëΩÂêç‰π¶Á±ç';
            const author = document.getElementById('epub-author').value || 'Êú™Áü•‰ΩúËÄÖ';
            const fileName = sanitizeFilename(
                document.getElementById('epub-filename').value || 'ebook'
            );
            
            const convertBtn = document.getElementById('convert-btn');
            convertBtn.disabled = true;
            convertBtn.innerHTML = 'ËΩ¨Êç¢‰∏≠ <i class="fas fa-spinner fa-spin"></i>';
            
            try {
                // ÂàõÂª∫EPUB‰π¶Á±çÂØπË±°
                const book = new JSZip();
                currentBook = book;
                
                // Âü∫Êú¨Êñá‰ª∂ÁªìÊûÑ
                book.file("mimetype", "application/epub+zip");
                const META_INF = book.folder("META-INF");
                META_INF.file("container.xml", `<?xml version="1.0"?>
<container version="1.0" xmlns="urn:oasis:names:tc:opendocument:xmlns:container">
  <rootfiles>
    <rootfile full-path="OEBPS/content.opf" media-type="application/oebps-package+xml"/>
  </rootfiles>
</container>`);
                
                const OEBPS = book.folder("OEBPS");
                
                // ÁîüÊàêÂÜÖÂÆπÊñá‰ª∂
                updateProgress(10, "Â§ÑÁêÜÁ´†ËäÇÂÜÖÂÆπ...");
                
                // ÂàõÂª∫Â∞ÅÈù¢È°µ - ‰øÆÂ§çiOSÂÖºÂÆπÊÄßÈóÆÈ¢ò
                let coverHtml = `<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
<head>
  <title>${title} - Â∞ÅÈù¢</title>
  <style>
    body { 
        margin: 0; 
        padding: 0; 
        text-align: center; 
        background: #f8f9fa; 
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
    }
    .cover-container { 
        max-width: 80%;
        text-align: center;
    }
    .cover-title { 
        font-size: 1.1rem;  /* ‰∏éÊ≠£ÊñáÂ≠ó‰ΩìÂ§ßÂ∞èÁõ∏Âêå */
        font-weight: bold;
        margin-bottom: 0.5rem;
        color: #333;
        text-align: center;
        width: 100%;
    }
    .cover-author { 
        font-size: 1.1rem;  /* ‰∏éÊ≠£ÊñáÂ≠ó‰ΩìÂ§ßÂ∞èÁõ∏Âêå */
        color: #666;
        text-align: center;
        width: 100%;
    }
    .cover-image { 
        max-width: 60%; 
        max-height: 60vh; 
        margin: 0 auto 1.5rem; 
        border: 1px solid #ddd; 
        box-shadow: 0 5px 20px rgba(0,0,0,0.1); 
        border-radius: 5px; 
    }
  </style>
</head>
<body>
  <div class="cover-container">`;
                
                // Ê∑ªÂä†Â∞ÅÈù¢ÂõæÁâáÔºàÂ¶ÇÊûú‰∏ä‰º†‰∫ÜÔºâ
                let coverImageName = "";
                let mediaType = "";
                
                if (coverImageFile) {
                    coverImageName = `cover.${coverImageType.split('/')[1]}`;
                    mediaType = coverImageType;
                    
                    // Ê∑ªÂä†Â∞ÅÈù¢ÂõæÁâáÂà∞EPUB
                    OEBPS.file(coverImageName, coverImageFile);
                    
                    // Âú®Â∞ÅÈù¢È°µ‰∏≠ÂåÖÂê´ÂõæÁâá - ‰øÆÂ§çiOSÂÖºÂÆπÊÄßÈóÆÈ¢òÔºàÊ≠£Á°Æ‰ΩøÁî®Ëá™Èó≠ÂêàÊ†áÁ≠æÔºâ
                    coverHtml += `
    <img class="cover-image" src="${coverImageName}" alt="${title} Â∞ÅÈù¢" />
    <div class="cover-title">${title}</div>
    <div class="cover-author">${author}</div>
  </div>
</body>
</html>`;
                } else {
                    // Ê≤°ÊúâÂ∞ÅÈù¢ÂõæÁâáÊó∂‰ΩøÁî®ÊñáÂ≠óÂ∞ÅÈù¢
                    coverHtml += `
    <div class="cover-title">${title}</div>
    <div class="cover-author">${author}</div>
    <div style="margin-top: 2em; font-style: italic; color: #777; font-size: 1.1rem;">
      Êú¨‰π¶Áî±TXTËΩ¨EPUBÂ∑•ÂÖ∑ÁîüÊàê<br />
      ${new Date().toLocaleDateString()}
    </div>
  </div>
</body>
</html>`;
                }
                
                OEBPS.file("cover.html", coverHtml);
                
                // ÂàõÂª∫ÁõÆÂΩïHTMLÊñá‰ª∂
                updateProgress(20, "ÁîüÊàêÁõÆÂΩïÁªìÊûÑ...");
                let tocHtml = `<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
<head>
  <title>ÁõÆÂΩï</title>
  <style>
    body { font-family: sans-serif; line-height: 1.6; margin: 0; padding: 20px; background: #f8f9fa; }
    h1 { text-align: center; margin-bottom: 30px; color: #333; }
    nav ol { list-style: none; padding: 0; max-width: 800px; margin: 0 auto; }
    nav li { padding: 12px 15px; border-bottom: 1px solid #eee; background: white; }
    nav a { text-decoration: none; color: #333; display: block; font-size: 1.1rem; }
    nav li.level-1 { font-weight: bold; padding-left: 20px; border-left: 4px solid #4361ee; }
    nav li.level-2 { padding-left: 40px; border-left: 4px solid #4895ef; }
    nav li.level-3 { padding-left: 60px; font-size: 1rem; border-left: 4px solid #f9a826; }
    nav li:hover { background: #f0f4ff; }
  </style>
</head>
<body>
  <h1>${title}</h1>
  <h2 style="text-align: center; color: #666; margin-bottom: 30px;">ÁõÆÂΩï</h2>
  <nav id="toc" epub:type="toc">
    <ol>
      <li class="level-0">
        <a href="cover.html">Â∞ÅÈù¢</a>
      </li>`;

                // ÊèêÂèñÁÆÄ‰ªãÂÜÖÂÆπÔºàÁ¨¨‰∏ÄÁ´†‰πãÂâçÁöÑÂÜÖÂÆπÔºâ
                let introContent = '';
                let introHtml = '';
                let introExists = false;
                
                if (chapters.length > 0) {
                    const firstChapterLine = chapters[0].line - 1; // Á´†ËäÇË°åÂè∑‰ªé1ÂºÄÂßãÔºåËΩ¨Êç¢‰∏∫Á¥¢Âºï
                    const contentLines = txtContent.split('\n');
                    
                    // ÊèêÂèñ‰ªé0Ë°åÂà∞firstChapterLine-1Ë°åÔºàÁÆÄ‰ªã‰∏çÂåÖÊã¨Á´†ËäÇÊ†áÈ¢òË°åÔºâ
                    for (let j = 0; j < firstChapterLine; j++) {
                        if (contentLines[j].trim() !== '') {
                            introContent += `<p>${contentLines[j]}</p>\n`;
                        }
                    }
                    
                    // Â¶ÇÊûúÁÆÄ‰ªãÂÜÖÂÆπÈùûÁ©∫ÔºåÂàôÁîüÊàêÁÆÄ‰ªãÁ´†ËäÇ
                    if (introContent.trim() !== '') {
                        introExists = true;
                        
                        // ÁîüÊàêÁÆÄ‰ªãÁöÑHTMLÊñá‰ª∂
                        introHtml = `<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
<head>
  <title>ÁÆÄ‰ªã</title>
  <style>
    body { font-family: serif; line-height: 1.8; margin: 0; padding: 30px; background: none; color: inherit; }
    .intro-title { font-size: 2.2rem; text-align: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px solid #eee; color: #222; }
    .intro-content { margin-top: 1.5rem; text-indent: 2em; font-size: 1.1rem; }
  </style>
</head>
<body>
  <h1 class="intro-title">ÁÆÄ‰ªã</h1>
  <div class="intro-content">\n${introContent}\n  </div>
</body>
</html>`;
                        
                        OEBPS.file("intro.html", introHtml);
                        
                        // Âú®ÁõÆÂΩï‰∏≠Ê∑ªÂä†ÁÆÄ‰ªã
                        tocHtml += `
      <li class="level-0">
        <a href="intro.html">ÁÆÄ‰ªã</a>
      </li>`;
                    }
                }
                
                // ÊûÑÂª∫Á´†ËäÇÊ†ëÁªìÊûÑÔºà‰øÆÂ§çÁõÆÂΩïÈóÆÈ¢òÔºâ
                const chapterTree = buildChapterTree();
                
                // ÈÄíÂΩíÁîüÊàêÂµåÂ•óÁõÆÂΩïHTML
                function generateTocHtml(tree) {
                    let html = '';
                    for (const node of tree) {
                        html += `
          <li class="level-${node.level}">
            <a href="${node.id}.html">${node.title}</a>`;
                        
                        if (node.children.length > 0) {
                            html += `
            <ol>${generateTocHtml(node.children)}</ol>`;
                        }
                        
                        html += `
          </li>`;
                    }
                    return html;
                }
                
                // Ê∑ªÂä†Á´†ËäÇÂà∞ÁõÆÂΩï
                tocHtml += generateTocHtml(chapterTree);
                
                tocHtml += `
    </ol>
  </nav>
</body>
</html>`;
                
                OEBPS.file("toc.html", tocHtml);
                
                // Ê∑ªÂä†Á´†ËäÇÂÜÖÂÆπ
                updateProgress(30, "ÁîüÊàêÁ´†ËäÇÂÜÖÂÆπ...");
                let currentChapterStart = 0;
                const contentLines = txtContent.split('\n');
                
                // ÈÄíÂΩíÁîüÊàêÁ´†ËäÇHTMLÊñá‰ª∂
                function generateChapterFiles(tree) {
                    for (const node of tree) {
                        // ÂàõÂª∫Á´†ËäÇHTMLÊñá‰ª∂
                        let chapterHtml = `<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
<head>
  <title>${node.title}</title>
  <style>
    body { font-family: serif; line-height: 1.8; margin: 0; padding: 30px; background: none; color: inherit; }
    .chapter-title { font-size: 2.2rem; text-align: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px solid #eee; color: #222; }
    .chapter-content { margin-top: 1.5rem; text-indent: 2em; font-size: 1.1rem; }
  </style>
</head>
<body>
  <h1 class="chapter-title">${node.title}</h1>
  <div class="chapter-content">\n`;
                        
                        // Ê∑ªÂä†Á´†ËäÇÂÜÖÂÆπ
                        const nextIndex = chapters.findIndex(c => c.line > node.line);
                        const endLine = nextIndex >= 0 ? chapters[nextIndex].line - 1 : contentLines.length;
                        
                        for (let j = node.line - 1; j < endLine; j++) {
                            // Ë∑≥ËøáÁ´†ËäÇÊ†áÈ¢òË°åÔºàÈÅøÂÖçÂú®ÂÜÖÂÆπ‰∏≠ÈáçÂ§çÂá∫Áé∞Ê†áÈ¢òÔºâ
                            if (j !== (node.line - 1) && contentLines[j].trim() !== '') {
                                chapterHtml += `<p>${contentLines[j]}</p>\n`;
                            }
                        }
                        
                        chapterHtml += `  </div>
</body>
</html>`;
                        
                        // ‰øùÂ≠òÁ´†ËäÇHTMLÊñá‰ª∂
                        OEBPS.file(`${node.id}.html`, chapterHtml);
                        
                        // ÈÄíÂΩíÂ§ÑÁêÜÂ≠êËäÇÁÇπ
                        if (node.children.length > 0) {
                            generateChapterFiles(node.children);
                        }
                    }
                }
                
                // ÁîüÊàêÊâÄÊúâÁ´†ËäÇÊñá‰ª∂
                generateChapterFiles(chapterTree);
                
                // ÁîüÊàêOPFÊñá‰ª∂Ôºà‰øÆÂ§çÁõÆÂΩïÈóÆÈ¢òÔºâ
                updateProgress(60, "ÁîüÊàêÂÖÉÊï∞ÊçÆ...");
                
                // ÈÄíÂΩíÁîüÊàêmanifestÂíåspineÂÜÖÂÆπ
                function generateManifestAndSpine(tree) {
                    let manifest = '';
                    let spine = '';
                    
                    function traverse(node) {
                        manifest += `<item id="${node.id}" href="${node.id}.html" media-type="application/xhtml+xml"/>\n    `;
                        spine += `<itemref idref="${node.id}"/>\n    `;
                        
                        for (const child of node.children) {
                            traverse(child);
                        }
                    }
                    
                    for (const node of tree) {
                        traverse(node);
                    }
                    
                    return { manifest, spine };
                }
                
                const { manifest: chapterManifest, spine: chapterSpine } = generateManifestAndSpine(chapterTree);
                
                const opfContent = `<?xml version="1.0" encoding="UTF-8"?>
<package xmlns="http://www.idpf.org/2007/opf" unique-identifier="bookid" version="3.0">
  <metadata xmlns:dc="http://purl.org/dc/elements/1.1/">
    <dc:identifier id="bookid">urn:uuid:${generateUUID()}</dc:identifier>
    <dc:title>${title}</dc:title>
    <dc:creator>${author}</dc:creator>
    <dc:language>zh-CN</dc:language>
    <meta property="dcterms:modified">${new Date().toISOString()}</meta>
    ${coverImageName ? `<meta name="cover" content="cover-image"/>` : ''}
  </metadata>
  <manifest>
    <item id="cover" href="cover.html" media-type="application/xhtml+xml"/>
    <item id="toc" href="toc.html" media-type="application/xhtml+xml" properties="nav"/>
    <item id="ncx" href="toc.ncx" media-type="application/x-dtbncx+xml"/>
    ${coverImageName ? `<item id="cover-image" href="${coverImageName}" media-type="${mediaType}" properties="cover-image"/>` : ''}
    ${introExists ? `<item id="intro" href="intro.html" media-type="application/xhtml+xml"/>` : ''}
    
    <!-- Á´†ËäÇÊñá‰ª∂ -->
    ${chapterManifest}
  </manifest>
  <spine toc="ncx">
    <itemref idref="cover"/>
    ${introExists ? `<itemref idref="intro"/>` : ''}
    ${chapterSpine}
  </spine>
  <guide>
    <reference type="cover" title="Â∞ÅÈù¢" href="cover.html"/>
    <reference type="toc" title="ÁõÆÂΩï" href="toc.html"/>
  </guide>
</package>`;
                
                OEBPS.file("content.opf", opfContent);
                
                // ÁîüÊàêNCXÊñá‰ª∂Ôºà‰øÆÂ§çÁõÆÂΩïÈóÆÈ¢òÔºâ
                updateProgress(80, "ÁîüÊàêÁõÆÂΩïÁ¥¢Âºï...");
                
                // ÈÄíÂΩíÁîüÊàêNCXÂØºËà™ÁÇπ
                function generateNcxNavPoints(tree, playOrder = 1) {
                    let navContent = '';
                    let currentOrder = playOrder;
                    
                    for (const node of tree) {
                        navContent += `
    <navPoint id="${node.id}" playOrder="${currentOrder++}">
      <navLabel>
        <text>${node.title}</text>
      </navLabel>
      <content src="${node.id}.html"/>`;
                        
                        if (node.children.length > 0) {
                            const childContent = generateNcxNavPoints(node.children, currentOrder);
                            navContent += childContent.content;
                            currentOrder = childContent.nextOrder;
                        }
                        
                        navContent += `
    </navPoint>`;
                    }
                    
                    return { content: navContent, nextOrder: currentOrder };
                }
                
                // ÁîüÊàêNCXÂÜÖÂÆπ
                const ncxStartOrder = introExists ? 3 : 2;
                const ncxNavContent = generateNcxNavPoints(chapterTree, ncxStartOrder);
                
                let ncxContent = `<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE ncx PUBLIC "-//NISO//DTD ncx 2005-1//EN" "http://www.daisy.org/z3986/2005/ncx-2005-1.dtd">
<ncx xmlns="http://www.daisy.org/z3986/2005/ncx/" version="2005-1">
  <head>
    <meta name="dtb:uid" content="urn:uuid:${generateUUID()}"/>
  </head>
  <docTitle>
    <text>${title}</text>
  </docTitle>
  <navMap>
    <navPoint id="cover" playOrder="1">
      <navLabel>
        <text>Â∞ÅÈù¢</text>
      </navLabel>
      <content src="cover.html"/>
    </navPoint>`;
                
                // Ê∑ªÂä†ÁÆÄ‰ªãÂà∞NCXÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
                if (introExists) {
                    ncxContent += `
    <navPoint id="intro" playOrder="2">
      <navLabel>
        <text>ÁÆÄ‰ªã</text>
      </navLabel>
      <content src="intro.html"/>
    </navPoint>`;
                }
                
                // Ê∑ªÂä†Á´†ËäÇÂà∞NCX
                ncxContent += ncxNavContent.content;
                
                ncxContent += `
  </navMap>
</ncx>`;
                
                OEBPS.file("toc.ncx", ncxContent);
                
                // ÁîüÊàêEPUBÊñá‰ª∂Âπ∂‰∏ãËΩΩ
                updateProgress(90, "ÊâìÂåÖEPUBÊñá‰ª∂...");
                book.generateAsync({
                    type: "blob",
                    mimeType: "application/epub+zip",
                    compression: "DEFLATE",
                    compressionOptions: { level: 6 }
                }, (metadata) => {
                    // ÂÆûÊó∂Êõ¥Êñ∞ËøõÂ∫¶Êù°
                    updateProgress(90 + Math.floor(metadata.percent * 0.1), "ÊâìÂåÖEPUBÊñá‰ª∂...");
                }).then(function(content) {
                    updateProgress(100, "ËΩ¨Êç¢ÂÆåÊàê");
                    
                    // ‰øùÂ≠òÁîüÊàêÁöÑblob
                    generatedEpubBlob = content;
                    
                    // Êõ¥Êñ∞ÁïåÈù¢‰∏∫ËΩ¨Êç¢ÊàêÂäüÁä∂ÊÄÅ
                    document.getElementById('convert-info').className = 'alert alert-success';
                    document.getElementById('convert-info').innerHTML = `
                        <i class="fas fa-check-circle"></i>
                        <div>
                            <strong>ËΩ¨Êç¢ÊàêÂäü!</strong> 
                            <p>EPUBÊñá‰ª∂Â∑≤ÁîüÊàêÔºåÂåÖÂê´ ${chapters.length} ‰∏™Á´†ËäÇ${introExists ? 'ÂèäÁÆÄ‰ªã' : ''}</p>
                        </div>
                    `;
                    
                    // ÊòæÁ§∫‰∏ãËΩΩÊåâÈíÆ
                    const downloadSection = document.getElementById('download-section');
                    downloadSection.style.display = 'block';
                    
                    // Â∞ùËØïËá™Âä®‰∏ãËΩΩÔºàÂú®iOSÁöÑÊú¨Âú∞ÁéØÂ¢É‰∏≠‰∏çËá™Âä®‰∏ãËΩΩÔºâ
                    if (!isLocalEnvironment() || !isIOS()) {
                        saveAs(generatedEpubBlob, epubFileName);
                    }
                    
                    // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                    convertBtn.disabled = false;
                    convertBtn.innerHTML = 'ÈáçÊñ∞ËΩ¨Êç¢ <i class="fas fa-redo"></i>';
                }).catch(function(err) {
                    console.error("ÁîüÊàêEPUBÂ§±Ë¥•", err);
                    showError("ÁîüÊàêEPUBÂ§±Ë¥•", err.message || "Êú™Áü•ÈîôËØØ", "ËØ∑Â∞ùËØïÂáèÂ∞ëÁ´†ËäÇÊï∞ÈáèÊàñÊãÜÂàÜÂ§ßÊñá‰ª∂");
                    
                    // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                    convertBtn.disabled = false;
                    convertBtn.innerHTML = 'ÈáçÊñ∞Â∞ùËØï <i class="fas fa-redo"></i>';
                });
            } catch (err) {
                console.error("ÁîüÊàêEPUBÂ§±Ë¥•", err);
                showError("ÁîüÊàêEPUBÂ§±Ë¥•", err.message || "Êú™Áü•ÈîôËØØ", "ËØ∑Ê£ÄÊü•Êñá‰ª∂ÂÜÖÂÆπÂπ∂ÈáçËØï");
                
                // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                convertBtn.disabled = false;
                convertBtn.innerHTML = 'ÈáçÊñ∞Â∞ùËØï <i class="fas fa-redo"></i>';
            }
        }
        
        // ÁîüÊàêUUID
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0,
                      v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        
        // ÂàùÂßãÂåñÂ∑•ÂÖ∑
        function initTool() {
            // Ê∑ªÂä†‰∏ãËΩΩÊåâÈíÆ‰∫ã‰ª∂ÁõëÂê¨
            document.getElementById('download-btn').addEventListener('click', function() {
                if (generatedEpubBlob) {
                    saveAs(generatedEpubBlob, epubFileName);
                } else {
                    showError("Êñá‰ª∂Êú™ÁîüÊàê", "EPUBÊñá‰ª∂Â∞öÊú™ÁîüÊàêÊàñÂ∑≤ËøáÊúü", "ËØ∑ËøîÂõûÁ¨¨‰∫îÊ≠•ÈáçÊñ∞ÁîüÊàêEPUBÊñá‰ª∂");
                }
            });
            
            // Ê∑ªÂä†ÂÖ≥Èó≠Ê®°ÊÄÅÊ°ÜÁöÑESCÈîÆÊîØÊåÅ
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeModal();
                    closeErrorModal();
                }
            });
        }
        
        // ÂºÄÂßãÂä†ËΩΩÂ∫ì
        loadLibraries();
    </script>
</body>
</html>
