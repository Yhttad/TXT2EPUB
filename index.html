<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- æ·»åŠ å†…è”SVGå›¾æ ‡ä½œä¸ºfavicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><text x='0' y='14' font-size='14' fill='blue'>ğŸ“–</text></svg>">
    <title>TXTè½¬EPUBè½¬æ¢å·¥å…· - ä¸“ä¸šå°è¯´æ’ç‰ˆ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* åŸæœ‰CSSä¿æŒä¸å˜ */
        :root {
            --primary: #4361ee;
            --primary-light: #4895ef;
            --secondary: #7209b7;
            --success: #4caf50;
            --warning: #f9a826;
            --danger: #e63946;
            --gray: #f5f5f5;
            --gray-dark: #e0e0e0;
            --text: #333333;
            --text-light: #666666;
            --white: #ffffff;
            --shadow: rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f8f9fa;
            color: var(--text);
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--white);
            border-radius: 16px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            border: 1px solid #e1e8ed;
        }

        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
            transform: rotate(30deg);
        }

        header h1 {
            font-size: 2.2rem;
            margin-bottom: 12px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            position: relative;
        }

        header p {
            opacity: 0.9;
            max-width: 700px;
            margin: 0 auto;
            font-size: 1.1rem;
            position: relative;
        }

        .progress-steps {
            display: flex;
            background: var(--gray);
            padding: 15px 20px;
            position: relative;
            border-bottom: 1px solid #e0e0e0;
        }

        .progress-bar {
            position: absolute;
            height: 4px;
            background: var(--primary);
            top: 50%;
            transform: translateY(-50%);
            transition: all 0.5s ease;
            z-index: 1;
            box-shadow: 0 0 8px rgba(67, 97, 238, 0.4);
        }

        .step {
            flex: 1;
            text-align: center;
            position: relative;
            z-index: 2;
        }

        .step-icon {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: var(--white);
            color: var(--text-light);
            font-weight: bold;
            border: 3px solid var(--gray-dark);
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .step.active .step-icon {
            background: var(--primary);
            color: var(--white);
            border-color: var(--primary);
            transform: scale(1.1);
        }

        .step.done .step-icon {
            background: var(--success);
            color: var(--white);
            border-color: var(--success);
        }

        .step-text {
            display: block;
            margin-top: 8px;
            font-size: 0.9rem;
            color: var(--text-light);
            font-weight: 500;
        }

        .step.active .step-text,
        .step.done .step-text {
            color: var(--text);
            font-weight: 600;
        }

        .content-section {
            padding: 30px;
            display: none;
            background: #ffffff;
        }

        .content-section.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h2 {
            font-size: 1.6rem;
            color: var(--primary);
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--gray);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        h2 i {
            background: rgba(67, 97, 238, 0.15);
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            color: var(--primary);
        }

        .control-group {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px dashed var(--gray-dark);
        }

        .control-group:last-child {
            border-bottom: none;
        }

        .control-group h3 {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-group h3 i {
            color: var(--primary);
            font-size: 1.2rem;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text);
            font-size: 1rem;
        }

        input, select, textarea {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid var(--gray-dark);
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #ffffff;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
            outline: none;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 20px;
        }

        .file-upload {
            border: 3px dashed var(--gray-dark);
            border-radius: 16px;
            padding: 40px 30px;
            margin: 20px 0;
            transition: all 0.3s ease;
            position: relative;
            background: var(--gray);
            cursor: pointer;
            /* ä½¿ç”¨flexå¸ƒå±€ç¡®ä¿å®Œå…¨å±…ä¸­ */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .file-upload:hover {
            border-color: var(--primary);
            background: rgba(67, 97, 238, 0.05);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(67, 97, 238, 0.1);
        }

        .file-upload i {
            font-size: 3.5rem;
            color: var(--primary-light);
            margin-bottom: 20px;
            transition: all 0.3s;
        }

        .file-upload:hover i {
            transform: scale(1.1);
            color: var(--primary);
        }

        .file-upload h3 {
            font-size: 1.4rem;
            margin-bottom: 10px;
            color: var(--text);
        }

        .file-upload p {
            color: var(--text-light);
            margin-bottom: 25px;
            font-size: 1rem;
        }

        .upload-btn {
            display: inline-block;
            background: var(--primary);
            color: white;
            padding: 14px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            font-size: 1.05rem;
            box-shadow: 0 4px 10px rgba(67, 97, 238, 0.3);
        }

        .upload-btn:hover {
            background: var(--primary-light);
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(67, 97, 238, 0.4);
        }

        input[type="file"] {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0;
            cursor: pointer;
        }

        .hierarchy-rules {
            background: var(--gray);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid #e0e0e0;
        }

        .level-group {
            background: var(--white);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid #eee;
        }

        .level-header {
            font-weight: bold;
            color: var(--secondary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 1.2rem;
        }

        .level-header i {
            margin-right: 10px;
            color: var(--secondary);
            font-size: 1.3rem;
        }

        .level-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 18px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 28px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary);
        }

        input:checked + .slider:before {
            transform: translateX(30px);
        }

        .chapter-preview {
            max-height: 450px;
            overflow-y: auto;
            border: 1px solid var(--gray-dark);
            border-radius: 12px;
            padding: 20px;
            margin-top: 25px;
            background: var(--white);
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.05);
        }

        .chapter-item {
            padding: 12px 15px;
            border-left: 4px solid var(--gray);
            margin-bottom: 10px;
            transition: all 0.3s ease;
            position: relative;
            border-radius: 8px;
            background: #ffffff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        }

        .chapter-item:hover {
            background: #f8f9ff;
            border-left-color: var(--primary);
            transform: translateX(5px);
        }

        .chapter-item.level-1 {
            border-left-color: var(--primary);
            font-weight: bold;
            padding-left: 20px;
            background: #f0f4ff;
        }

        .chapter-item.level-2 {
            padding-left: 30px;
            border-left-color: var(--primary-light);
        }

        .chapter-item.level-3 {
            padding-left: 40px;
            border-left-color: var(--warning);
        }

        .chapter-item.invalid {
            background: rgba(255, 213, 79, 0.15);
            border-left: 4px solid var(--warning);
        }

        .chapter-item.invalid::after {
            content: "!";
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--warning);
            color: white;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .chapter-label {
            font-size: 0.85rem;
            background: rgba(67, 97, 238, 0.15);
            color: var(--primary);
            padding: 4px 10px;
            border-radius: 20px;
            margin-right: 10px;
            font-weight: 600;
        }

        .btn-container {
            display: flex;
            justify-content: space-between;
            margin-top: 35px;
            gap: 15px;
        }

        .btn {
            padding: 14px 32px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-size: 1.05rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn i {
            font-size: 1.1rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
        }

        .btn-primary:hover {
            background: var(--primary-light);
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(67, 97, 238, 0.4);
        }

        .btn-outline {
            background: transparent;
            color: var(--text);
            border: 2px solid var(--gray-dark);
        }

        .btn-outline:hover {
            background: var(--gray);
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .btn-success {
            background: var(--success);
            color: white;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .btn-success:hover {
            background: #388e3c;
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(76, 175, 80, 0.4);
        }

        .alert {
            padding: 18px;
            border-radius: 12px;
            margin-bottom: 25px;
            display: flex;
            align-items: flex-start;
            gap: 15px;
            border-left: 5px solid;
        }

        .alert i {
            font-size: 1.6rem;
            flex-shrink: 0;
        }

        .alert-danger {
            background: rgba(230, 57, 70, 0.1);
            color: var(--danger);
            border-left-color: var(--danger);
        }

        .alert-info {
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary);
            border-left-color: var(--primary);
        }

        .alert-success {
            background: rgba(76, 175, 80, 0.1);
            color: var(--success);
            border-left-color: var(--success);
        }

        .progress-container {
            width: 100%;
            height: 14px;
            background: var(--gray-dark);
            border-radius: 7px;
            overflow: hidden;
            margin-top: 30px;
            position: relative;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
        }

        .progress-bar-inner {
            height: 100%;
            background: var(--primary);
            border-radius: 7px;
            width: 0;
            transition: width 0.4s ease;
            background: linear-gradient(90deg, #4361ee, #7209b7);
        }

        .progress-stage {
            position: absolute;
            top: -30px;
            right: 0;
            font-size: 0.9rem;
            color: var(--text);
            font-weight: 500;
        }

        .download-link {
            display: inline-flex;
            align-items: center;
            margin-top: 25px;
            padding: 15px 30px;
            background: var(--success);
            color: white;
            border-radius: 12px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
            font-size: 1.1rem;
        }

        .download-link:hover {
            background: #388e3c;
            transform: translateY(-3px);
            box-shadow: 0 7px 20px rgba(76, 175, 80, 0.4);
        }

        .download-link i {
            margin-right: 12px;
            font-size: 1.3rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 850px;
            max-height: 90vh;
            overflow: auto;
            padding: 25px;
            position: relative;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.25);
            border: 1px solid #e0e0e0;
        }

        .close-modal {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 1.8rem;
            cursor: pointer;
            color: var(--text-light);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .close-modal:hover {
            background: #f5f5f5;
            color: var(--danger);
        }

        .modal-header {
            margin-bottom: 25px;
            border-bottom: 2px solid var(--gray);
            padding-bottom: 20px;
        }

        .modal-header h2 {
            margin-bottom: 0;
            font-size: 1.8rem;
        }

        .error-modal {
            background: rgba(230, 57, 70, 0.08);
            border-left: 5px solid var(--danger);
        }

        .platform-tips {
            background: rgba(67, 97, 238, 0.08);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            font-size: 0.95rem;
            border-left: 4px solid var(--primary);
        }

        .platform-tips h4 {
            margin-bottom: 12px;
            color: var(--primary);
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .platform-tips ul {
            padding-left: 25px;
        }

        .platform-tips li {
            margin-bottom: 10px;
            line-height: 1.6;
        }

        .cover-preview-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
            padding: 20px;
            background: #f9faff;
            border-radius: 12px;
            border: 1px dashed #4361ee;
        }

        .cover-preview-container img {
            max-width: 250px;
            max-height: 350px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .cover-preview-container h3 {
            color: var(--primary);
            font-size: 1.3rem;
        }

        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            backdrop-filter: blur(5px);
        }

        .spinner {
            border: 5px solid rgba(67, 97, 238, 0.3);
            border-radius: 50%;
            border-top: 5px solid var(--primary);
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #loading-message {
            font-size: 1.2rem;
            color: var(--text);
            text-align: center;
            max-width: 80%;
        }

        #retry-btn {
            margin-top: 20px;
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: none;
        }

        #retry-btn:hover {
            background: var(--primary-light);
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }

            .step-text {
                font-size: 0.75rem;
            }

            .level-controls {
                grid-template-columns: 1fr;
            }

            .btn-container {
                flex-direction: column;
            }

            .btn-container .btn {
                width: 100%;
                margin-bottom: 10px;
                justify-content: center;
            }

            header {
                padding: 20px 15px;
            }
            
            header h1 {
                font-size: 1.6rem;
            }
            
            .content-section {
                padding: 20px;
            }
            
            .modal-content {
                width: 95%;
                padding: 15px;
            }
            
            .file-upload {
                padding: 25px 15px;
            }
            
            .btn {
                padding: 12px 20px;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <div id="loading-overlay">
        <div class="spinner"></div>
        <div id="loading-message">æ­£åœ¨åŠ è½½å¿…è¦ç»„ä»¶ï¼Œè¯·ç¨å€™...</div>
        <button id="retry-btn">é‡è¯•åŠ è½½</button>
    </div>

    <div class="container">
        <header>
            <h1><i class="fas fa-book"></i> TXT è½¬ EPUB è½¬æ¢å·¥å…·</h1>
            <p>æ”¯æŒæœ¬åœ°è¿è¡Œï¼Œæ— éœ€æœåŠ¡å™¨ | å“åº”å¼è®¾è®¡ | è‡ªå®šä¹‰ç« èŠ‚å±‚çº§ | å®æ—¶é¢„è§ˆ | iOSä¼˜åŒ–</p>
        </header>

        <div class="progress-steps">
            <div class="progress-bar" style="width: 0%"></div>
            <div class="step active" data-step="1">
                <div class="step-icon">1</div>
                <span class="step-text">ä¸Šä¼ æ–‡ä»¶</span>
            </div>
            <div class="step" data-step="2">
                <div class="step-icon">2</div>
                <span class="step-text">å…ƒæ•°æ®</span>
            </div>
            <div class="step" data-step="3">
                <div class="step-icon">3</div>
                <span class="step-text">ç« èŠ‚è§„åˆ™</span>
            </div>
            <div class="step" data-step="4">
                <div class="step-icon">4</div>
                <span class="step-text">å°é¢è®¾ç½®</span>
            </div>
            <div class="step" data-step="5">
                <div class="step-icon">5</div>
                <span class="step-text">ç”Ÿæˆ EPUB</span>
            </div>
        </div>

        <!-- ä¸Šä¼ æ–‡ä»¶åŒºåŸŸ -->
        <section id="step-1" class="content-section active">
            <h2><i class="fas fa-file-upload"></i> ä¸Šä¼  TXT æ–‡ä»¶</h2>
            
            <div class="control-group">
                <div class="file-upload">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <h3>æ‹–æ”¾æ–‡ä»¶åˆ°æ­¤åŒºåŸŸæˆ–ç‚¹å‡»ä¸Šä¼ </h3>
                    <p>æ”¯æŒä»»ä½•æ–‡æœ¬ç¼–ç æ ¼å¼ï¼Œè‡ªåŠ¨è¯†åˆ« UTF-8ã€ASCII ç­‰å¸¸è§ç¼–ç </p>
                    <div class="upload-btn">é€‰æ‹© TXT æ–‡ä»¶</div>
                    <input type="file" id="txt-file" accept=".txt">
                </div>
                
                <div id="file-info" style="display: none;" class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        <strong>å·²æˆåŠŸä¸Šä¼ æ–‡ä»¶:</strong> 
                        <span id="filename"></span>
                        <div id="encoding-info"></div>
                    </div>
                </div>
            </div>
            
            <div class="btn-container">
                <div></div>
                <button class="btn btn-primary" onclick="nextStep(2)">ä¸‹ä¸€æ­¥ <i class="fas fa-arrow-right"></i></button>
            </div>
        </section>

        <!-- å…ƒæ•°æ®è®¾ç½®åŒºåŸŸ -->
        <section id="step-2" class="content-section">
            <h2><i class="fas fa-file-alt"></i> å…ƒæ•°æ®è®¾ç½®</h2>
            
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <div>
                    <strong>å…ƒæ•°æ®è¯´æ˜</strong> 
                    <p>è¿™äº›ä¿¡æ¯å°†åµŒå…¥åˆ° EPUB æ–‡ä»¶ä¸­ï¼Œå¸®åŠ©è¯†åˆ«ä¹¦ç±å†…å®¹å’Œä½œè€…</p>
                </div>
            </div>
            
            <div class="form-grid">
                <div class="control-group">
                    <h3><i class="fas fa-tag"></i> åŸºç¡€ä¿¡æ¯</h3>
                    <label for="epub-title">æ ‡é¢˜</label>
                    <input type="text" id="epub-title" placeholder="è¾“å…¥ä¹¦ç±æ ‡é¢˜">
                    
                    <label for="epub-author">ä½œè€…</label>
                    <input type="text" id="epub-author" placeholder="è¾“å…¥ä½œè€…å§“å">
                    
                    <label for="epub-filename">è¾“å‡ºæ–‡ä»¶å</label>
                    <input type="text" id="epub-filename" placeholder="è‡ªå®šä¹‰ EPUB æ–‡ä»¶å">
                </div>
                
                <div class="control-group">
                    <h3><i class="fas fa-align-left"></i> æè¿°ä¿¡æ¯</h3>
                    <label for="epub-description">å†…å®¹æè¿°</label>
                    <textarea id="epub-description" rows="4" placeholder="è¾“å…¥ä¹¦ç±ç®€ä»‹..."></textarea>
                    
                    <label for="epub-language">è¯­è¨€</label>
                    <input type="text" id="epub-language" value="zh-CN">
                    
                    <label for="epub-publisher">å‡ºç‰ˆå•†</label>
                    <input type="text" id="epub-publisher" placeholder="å‡ºç‰ˆå•†åç§°">
                </div>
            </div>
            
            <div class="btn-container">
                <button class="btn btn-outline" onclick="prevStep(1)"><i class="fas fa-arrow-left"></i> ä¸Šä¸€æ­¥</button>
                <button class="btn btn-primary" onclick="nextStep(3)">ä¸‹ä¸€æ­¥ <i class="fas fa-arrow-right"></i></button>
            </div>
        </section>

        <!-- ç« èŠ‚è§„åˆ™é…ç½®åŒºåŸŸ -->
        <section id="step-3" class="content-section">
            <h2><i class="fas fa-sitemap"></i> ç« èŠ‚å±‚çº§é…ç½®</h2>
            
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <div>
                    <strong>é…ç½®è¯´æ˜</strong> 
                    <p>å°è¯´å»ºè®®ä½¿ç”¨ä¸¤çº§ç»“æ„ï¼ˆå·+ç« ï¼‰ï¼ŒæŠ€æœ¯æ–‡æ¡£å¯å¯ç”¨ä¸‰çº§ç»“æ„</p>
                </div>
            </div>
            
            <div class="hierarchy-rules">
                <div class="level-group">
                    <div class="level-header">
                        <i class="fas fa-layer-group"></i> ç¬¬1å±‚çº§ (å·/éƒ¨)
                    </div>
                    <div class="level-controls">
                        <div>
                            <label for="l1-prefix">å‰ç¼€</label>
                            <input type="text" id="l1-prefix" placeholder="ä¾‹å¦‚: ç¬¬, âˆš, Chap">
                        </div>
                        <div>
                            <label for="l1-suffix">åç¼€</label>
                            <input type="text" id="l1-suffix" placeholder="ä¾‹å¦‚: å·|éƒ¨">
                        </div>
                        <div>
                            <label for="l1-separator">åˆ†éš”ç¬¦</label>
                            <input type="text" id="l1-separator" placeholder="ä¾‹å¦‚: ç©ºæ ¼æˆ–ç‚¹">
                        </div>
                        <div>
                            <label for="l1-numtype">æ•°å­—ç±»å‹</label>
                            <select id="l1-numtype">
                                <option value="chinese">ä¸­æ–‡æ•°å­—</option>
                                <option value="arabic">é˜¿æ‹‰ä¼¯æ•°å­—</option>
                                <option value="both" selected>æ··åˆè¯†åˆ«</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="level-group">
                    <div class="level-header">
                        <i class="fas fa-layer-group"></i> ç¬¬2å±‚çº§ (ç« /å›)
                    </div>
                    <div class="level-controls">
                        <div>
                            <label for="l2-prefix">å‰ç¼€</label>
                            <input type="text" id="l2-prefix" value="ç¬¬" placeholder="ä¾‹å¦‚: ç¬¬">
                        </div>
                        <div>
                            <label for="l2-suffix">åç¼€</label>
                            <input type="text" id="l2-suffix" value="ç« |ç« å›" placeholder="ä¾‹å¦‚: ç« |ç« å›">
                        </div>
                        <div>
                            <label for="l2-separator">åˆ†éš”ç¬¦</label>
                            <input type="text" id="l2-separator" value=" " placeholder="ä¾‹å¦‚: ç©ºæ ¼">
                        </div>
                        <div>
                            <label for="l2-numtype">æ•°å­—ç±»å‹</label>
                            <select id="l2-numtype">
                                <option value="chinese">ä¸­æ–‡æ•°å­—</option>
                                <option value="arabic" selected>é˜¿æ‹‰ä¼¯æ•°å­—</option>
                                <option value="both">æ··åˆè¯†åˆ«</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="level-group">
                    <div class="level-header">
                        <i class="fas fa-layer-group"></i> ç¬¬3å±‚çº§ (èŠ‚/æ®µ)
                        <label class="toggle-switch">
                            <input type="checkbox" id="toggle-level3"> 
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div id="level3-controls" style="display:none;">
                        <div class="level-controls">
                            <div>
                                <label for="l3-prefix">å‰ç¼€</label>
                                <input type="text" id="l3-prefix" placeholder="ä¾‹å¦‚: âœ…, â˜…">
                            </div>
                            <div>
                                <label for="l3-suffix">åç¼€</label>
                                <input type="text" id="l3-suffix" placeholder="ä¾‹å¦‚: èŠ‚|æ®µ">
                            </div>
                            <div>
                                <label for="l3-separator">åˆ†éš”ç¬¦</label>
                                <input type="text" id="l3-separator" value=". " placeholder="ä¾‹å¦‚: .">
                            </div>
                            <div>
                                <label for="l3-numtype">æ•°å­—ç±»å‹</label>
                                <select id="l3-numtype">
                                    <option value="chinese">ä¸­æ–‡æ•°å­—</option>
                                    <option value="arabic" selected>é˜¿æ‹‰ä¼¯æ•°å­—</option>
                                    <option value="both">æ··åˆè¯†åˆ«</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ç« èŠ‚è¯†åˆ«å‚æ•°é…ç½® -->
            <div class="form-grid">
                <div class="control-group">
                    <h3><i class="fas fa-cog"></i> ç« èŠ‚è¯†åˆ«å‚æ•°</h3>
                    
                    <label for="max-title-length">æœ€å¤§æ ‡é¢˜é•¿åº¦</label>
                    <input type="number" id="max-title-length" value="50" min="20" max="100">
                    <p style="font-size: 0.9rem; color: var(--text-light); margin-top: 5px;">
                        è¶…è¿‡æ­¤é•¿åº¦çš„è¡Œä¸ä¼šè¢«è¯†åˆ«ä¸ºç« èŠ‚æ ‡é¢˜
                    </p>
                    
                    <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                        <div>
                            <label for="min-gap-before">æ ‡é¢˜å‰æœ€å°ç©ºè¡Œæ•°</label>
                            <input type="number" id="min-gap-before" value="0" min="0" max="5">
                            <p style="font-size: 0.9rem; color: var(--text-light); margin-top: 5px;">
                                0=ä¸è¦æ±‚ç©ºè¡Œ
                            </p>
                        </div>
                        <div>
                            <label for="min-gap-after">æ ‡é¢˜åæœ€å°ç©ºè¡Œæ•°</label>
                            <input type="number" id="min-gap-after" value="0" min="0" max="5">
                            <p style="font-size: 0.9rem; color: var(--text-light); margin-top: 5px;">
                                0=ä¸è¦æ±‚ç©ºè¡Œ
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="btn-container">
                <button class="btn btn-outline" onclick="prevStep(2)"><i class="fas fa-arrow-left"></i> ä¸Šä¸€æ­¥</button>
                <button class="btn btn-primary" onclick="showChapterPreview()">é¢„è§ˆç« èŠ‚ç»“æ„</button>
                <button class="btn btn-primary" onclick="nextStep(4)">ä¸‹ä¸€æ­¥ <i class="fas fa-arrow-right"></i></button>
            </div>
        </section>

        <!-- å°é¢è®¾ç½®åŒºåŸŸ -->
        <section id="step-4" class="content-section">
            <h2><i class="fas fa-image"></i> å°é¢è®¾ç½®</h2>
            
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <div>
                    <strong>å°é¢è¯´æ˜</strong> 
                    <p>å°é¢å›¾ç‰‡å°†ä½œä¸º EPUB æ–‡ä»¶çš„å°é¢æ˜¾ç¤º</p>
                </div>
            </div>
            
            <div class="form-grid">
                <div class="control-group">
                    <h3><i class="fas fa-book-cover"></i> å°é¢å›¾ç‰‡</h3>
                    <label for="cover-file">ä¸Šä¼ å°é¢</label>
                    <input type="file" id="cover-file" accept=".jpg,.jpeg,.png">
                    <p style="font-size: 0.95rem; color: var(--text-light); margin-top: 8px;">
                        æ”¯æŒ JPG æˆ– PNG æ ¼å¼ï¼Œå»ºè®®å°ºå¯¸ï¼š600Ã—800åƒç´ 
                    </p>
                    
                    <div id="cover-preview" class="cover-preview-container" style="display: none;">
                        <h3><i class="fas fa-image"></i> å°é¢é¢„è§ˆ</h3>
                        <img id="cover-image" src="" alt="å°é¢é¢„è§ˆ">
                        <p id="cover-filename" style="color: var(--text-light); margin-top: 10px;"></p>
                    </div>
                </div>
            </div>
            
            <div class="btn-container">
                <button class="btn btn-outline" onclick="prevStep(3)"><i class="fas fa-arrow-left"></i> ä¸Šä¸€æ­¥</button>
                <button class="btn btn-primary" onclick="nextStep(5)">ç”Ÿæˆ EPUB <i class="fas fa-book"></i></button>
            </div>
        </section>

        <!-- ç”Ÿæˆè¿›åº¦åŒºåŸŸ -->
        <section id="step-5" class="content-section">
            <h2><i class="fas fa-cogs"></i> ç”Ÿæˆ EPUB æ–‡ä»¶</h2>
            
            <div id="convert-info" class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <div>
                    <strong>å‡†å¤‡ç”Ÿæˆ EPUB</strong> 
                    <p>å°†æ ¹æ®æ‚¨çš„è®¾ç½®ç”Ÿæˆ EPUB ç”µå­ä¹¦æ–‡ä»¶</p>
                </div>
            </div>
            
            <div class="control-group">
                <h3><i class="fas fa-book"></i> è¾“å‡ºä¿¡æ¯</h3>
                <div class="form-grid">
                    <div>
                        <label>æ ‡é¢˜</label>
                        <input type="text" id="output-title" disabled>
                    </div>
                    <div>
                        <label>ä½œè€…</label>
                        <input type="text" id="output-author" disabled>
                    </div>
                    <div>
                        <label>æ–‡ä»¶å</label>
                        <input type="text" id="output-filename" disabled>
                    </div>
                    <div>
                        <label>ç« èŠ‚æ•°é‡</label>
                        <input type="text" id="output-chapters" disabled>
                    </div>
                </div>
            </div>
            
            <div class="progress-container">
                <div id="progress-bar" class="progress-bar-inner"></div>
                <div id="progress-stage" class="progress-stage">å‡†å¤‡ä¸­...</div>
            </div>
            
            <div id="download-section" style="display:none; text-align:center; margin-top:25px;">
                <h3>EPUB æ–‡ä»¶å·²ç”Ÿæˆ</h3>
                <button id="download-btn" class="download-link">
                    <i class="fas fa-download"></i> ä¸‹è½½ EPUB æ–‡ä»¶
                </button>
                <div class="platform-tips">
                    <h4><i class="fas fa-info-circle"></i> å¹³å°ä¸‹è½½æç¤º</h4>
                    <ul>
                        <li><strong>iOS ç”¨æˆ·</strong>: ç‚¹å‡»ä¸‹è½½æŒ‰é’®åï¼Œåœ¨Safarièœå•ä¸­é€‰æ‹©"ä¸‹è½½é“¾æ¥æ–‡ä»¶"ï¼Œç„¶åä¿å­˜åˆ°"æ–‡ä»¶"åº”ç”¨</li>
                        <li><strong>Android ç”¨æˆ·</strong>: æ–‡ä»¶å°†ä¿å­˜åˆ°é»˜è®¤ä¸‹è½½ç›®å½•ï¼Œå¯åœ¨"æ–‡ä»¶ç®¡ç†"ä¸­æ‰¾åˆ°</li>
                        <li><strong>Windows ç”¨æˆ·</strong>: æ–‡ä»¶å°†ä¿å­˜åˆ°æµè§ˆå™¨é»˜è®¤ä¸‹è½½ä½ç½®</li>
                    </ul>
                </div>
            </div>
            
            <div class="btn-container">
                <button class="btn btn-outline" onclick="prevStep(4)"><i class="fas fa-arrow-left"></i> ä¸Šä¸€æ­¥</button>
                <button id="convert-btn" class="btn btn-success" onclick="convertToEpub()">å¼€å§‹è½¬æ¢ <i class="fas fa-magic"></i></button>
            </div>
        </section>
    </div>

    <!-- ç« èŠ‚é¢„è§ˆæ¨¡æ€æ¡† -->
    <div id="chapter-preview-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <div class="modal-header">
                <h2><i class="fas fa-eye"></i> ç« èŠ‚è¯†åˆ«é¢„è§ˆ</h2>
            </div>
            
            <div id="preview-alert" class="alert alert-success">
                <i class="fas fa-check-circle"></i>
                <div>
                    <strong>è¯†åˆ«æˆåŠŸ!</strong> 
                    å…±æ£€æµ‹åˆ° <span id="chapter-count">0</span> ä¸ªç« èŠ‚
                </div>
            </div>
            
            <div id="preview-container" class="chapter-preview">
                <!-- åŠ¨æ€ç”Ÿæˆé¢„è§ˆå†…å®¹ -->
            </div>
            
            <div class="btn-container" style="margin-top: 20px;">
                <button class="btn btn-outline" onclick="closeModal()">å…³é—­é¢„è§ˆ</button>
                <button class="btn btn-primary" onclick="applyPreviewChanges()">åº”ç”¨è®¾ç½®</button>
            </div>
        </div>
    </div>

    <!-- é”™è¯¯æç¤ºæ¨¡æ€æ¡† -->
    <div id="error-modal" class="modal">
        <div class="modal-content error-modal">
            <span class="close-modal" onclick="closeErrorModal()">&times;</span>
            <div class="modal-header">
                <h2><i class="fas fa-exclamation-triangle"></i> è½¬æ¢å¤±è´¥</h2>
            </div>
            
            <div id="error-content" style="padding: 20px; font-size: 1.1rem;">
                <!-- é”™è¯¯å†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
            
            <div class="btn-container" style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="closeErrorModal()">å…³é—­</button>
            </div>
        </div>
    </div>

    <script>
        // åŠ¨æ€åŠ è½½JSZipå’ŒFileSaver.js
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }
        
        // æ£€æµ‹æ˜¯å¦iOSç³»ç»Ÿ
        function isIOS() {
            return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        }
        
        // æ£€æµ‹æ˜¯å¦åœ¨æœ¬åœ°æ–‡ä»¶ç¯å¢ƒä¸­
        function isLocalEnvironment() {
            return window.location.protocol === 'file:';
        }
        
        // åŠ è½½å¿…è¦çš„åº“
        async function loadLibraries() {
            const loadingOverlay = document.getElementById('loading-overlay');
            const loadingMessage = document.getElementById('loading-message');
            const retryBtn = document.getElementById('retry-btn');
            
            try {
                // å°è¯•åŠ è½½JSZipå’ŒFileSaver
                loadingMessage.textContent = 'æ­£åœ¨åŠ è½½JSZipåº“...';
                await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js');
                
                loadingMessage.textContent = 'æ­£åœ¨åŠ è½½FileSaveråº“...';
                await loadScript('https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js');
                
                // æ£€æŸ¥åº“æ˜¯å¦åŠ è½½æˆåŠŸ
                if (typeof JSZip === 'undefined' || typeof saveAs === 'undefined') {
                    throw new Error('æ ¸å¿ƒåº“æœªæ­£ç¡®åŠ è½½');
                }
                
                // éšè—åŠ è½½ç•Œé¢
                loadingOverlay.style.display = 'none';
                
                // åˆå§‹åŒ–å·¥å…·
                initTool();
            } catch (error) {
                console.error('åº“åŠ è½½å¤±è´¥:', error);
                loadingMessage.innerHTML = `åŠ è½½å¤±è´¥: ${error.message}<br>è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•`;
                retryBtn.style.display = 'block';
            }
        }
        
        // é‡è¯•åŠ è½½
        document.getElementById('retry-btn').addEventListener('click', loadLibraries);
        
        // è¿›åº¦ç®¡ç†å’Œæ­¥éª¤æ§åˆ¶
        let currentStep = 1;
        let txtContent = "";
        let chapters = [];
        let currentBook = null;
        let coverImageFile = null;
        let coverImageType = "";
        let generatedEpubBlob = null;
        let epubFileName = "";
        
        function nextStep(step) {
            document.querySelector(`#step-${currentStep}`).classList.remove('active');
            document.querySelector(`.step[data-step="${currentStep}"]`).classList.remove('active');
            
            currentStep = step;
            
            document.querySelector(`#step-${currentStep}`).classList.add('active');
            document.querySelector(`.step[data-step="${currentStep}"]`).classList.add('active');
            
            // æ›´æ–°è¿›åº¦æ¡
            const progress = Math.round((currentStep - 1) * (100 / 4));
            document.querySelector('.progress-bar').style.width = `${progress}%`;
        }
        
        function prevStep(step) {
            nextStep(step);
        }
        
        // æ‰“å¼€ç« èŠ‚é¢„è§ˆæ¨¡æ€æ¡†
        function showChapterPreview() {
            // è¯†åˆ«ç« èŠ‚
            identifyChapters();
            
            // æ›´æ–°UI
            document.getElementById('preview-alert').style.display = 'flex';
            document.getElementById('chapter-count').textContent = chapters.length;
            
            // æ¸²æŸ“é¢„è§ˆ
            const previewContainer = document.getElementById('preview-container');
            previewContainer.innerHTML = '';
            
            // é™åˆ¶é¢„è§ˆæ•°é‡
            const maxPreview = 20;
            const previewChapters = chapters.slice(0, maxPreview);
            
            // åŠ¨ç”»æ•ˆæœ
            let delay = 0;
            previewChapters.forEach(chapter => {
                setTimeout(() => {
                    const item = document.createElement('div');
                    item.className = `chapter-item level-${chapter.level} ${chapter.valid ? '' : 'invalid'}`;
                    item.innerHTML = `
                        <span class="chapter-label">[${chapter.level}çº§]</span> <span>${chapter.title}</span>
                        <span style="float: right; color: var(--text-light);">ç¬¬${chapter.line}è¡Œ</span>
                    `;
                    previewContainer.appendChild(item);
                    item.style.opacity = '0';
                    item.style.transform = 'translateY(10px)';
                    
                    setTimeout(() => {
                        item.style.transition = 'all 0.3s ease';
                        item.style.opacity = '1';
                        item.style.transform = 'translateY(0)';
                    }, 10);
                }, delay);
                
                delay += 80;
            });
            
            // æ˜¾ç¤ºæ›´å¤šé€‰é¡¹
            if (chapters.length > maxPreview) {
                const moreItem = document.createElement('div');
                moreItem.className = 'chapter-item';
                moreItem.innerHTML = `
                    <span class="chapter-label">[...]</span>
                    <span>è¿˜æœ‰ ${chapters.length - maxPreview} ä¸ªç« èŠ‚æœªæ˜¾ç¤º</span>
                `;
                previewContainer.appendChild(moreItem);
            }
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('chapter-preview-modal').style.display = 'flex';
        }
        
        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('chapter-preview-modal').style.display = 'none';
        }
        
        // åº”ç”¨é¢„è§ˆè®¾ç½®
        function applyPreviewChanges() {
            closeModal();
            nextStep(4);
        }
        
        // å…³é—­é”™è¯¯æ¨¡æ€æ¡†
        function closeErrorModal() {
            document.getElementById('error-modal').style.display = 'none';
        }
        
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(title, message, solution) {
            const errorContent = document.getElementById('error-content');
            errorContent.innerHTML = `
                <h3 style="color: var(--danger); margin-bottom: 15px;">${title}</h3>
                <p style="margin-bottom: 20px;">${message}</p>
                <div class="alert alert-info" style="margin-top: 20px;">
                    <i class="fas fa-lightbulb"></i>
                    <div>
                        <strong>è§£å†³æ–¹æ¡ˆ</strong> 
                        <p>${solution}</p>
                    </div>
                </div>
            `;
            document.getElementById('error-modal').style.display = 'flex';
        }

        // ä¸‰çº§ç»“æ„å¼€å…³æ§åˆ¶
        document.getElementById('toggle-level3').addEventListener('change', function() {
            const level3Controls = document.getElementById('level3-controls');
            if (this.checked) {
                level3Controls.style.display = 'block';
            } else {
                level3Controls.style.display = 'none';
            }
        });

        // æ–‡ä»¶ä¸Šä¼ å¤„ç†
        const fileInput = document.getElementById('txt-file');
        const filenameSpan = document.getElementById('filename');
        const encodingInfo = document.getElementById('encoding-info');
        const fileInfoDiv = document.getElementById('file-info');
        
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // æ™ºèƒ½è§£ææ–‡ä»¶å - ä¼˜å…ˆè§£æä¹¦åå·æ ¼å¼
                const fileName = file.name;
                let bookTitle = fileName.replace('.txt', '');
                let authorName = '';
                
                // æ–°é€»è¾‘ï¼šä¼˜å…ˆè¯†åˆ«ã€Šä¹¦åã€‹æ ¼å¼
                const pattern1 = /ã€Š(.+?)ã€‹/;  // åŒ¹é…ã€Šä¹¦åã€‹æ ¼å¼
                const match1 = fileName.match(pattern1);
                
                // æ—§æ¨¡å¼ï¼šä¹¦åã€‹ä½œè€…ï¼šä½œè€…å
                const pattern2 = /ã€Š(.+?)ã€‹\s*ä½œè€…[:ï¼š]\s*(.+)/;
                const match2 = fileName.match(pattern2);
                
                if (match1) {
                    bookTitle = match1[1];
                    authorName = fileName.replace(match1[0], '')     // ç§»é™¤ä¹¦åå·éƒ¨åˆ†
                                        .replace('.txt', '')        // ç§»é™¤æ–‡ä»¶æ‰©å±•å
                                        .replace(/^\s+|\s+$/g, '')  // ç§»é™¤é¦–å°¾ç©ºæ ¼
                                        .replace(/^[-_]\s*|\s*[-_]$/g, ''); // ç§»é™¤é¦–å°¾è¿æ¥ç¬¦
                } else if (match2) {
                    bookTitle = match2[1];
                    authorName = match2[2].replace('.txt', '');
                } else {
                    bookTitle = fileName.replace('.txt', '');
                }
                
                // å¡«å……åˆ°è¡¨å•
                document.getElementById('epub-title').value = bookTitle;
                document.getElementById('epub-author').value = authorName;
                document.getElementById('epub-filename').value = bookTitle;
                
                // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
                filenameSpan.textContent = file.name;
                fileInfoDiv.style.display = 'flex';
                
                // å°è¯•è¯†åˆ«ç¼–ç å¹¶è¯»å–æ–‡ä»¶ï¼ˆæ”¯æŒUTF-8ã€UTF-16LEã€GBKï¼‰
                const reader = new FileReader();
                reader.onload = function(event) {
                    const buffer = event.target.result;
                    let encoding = null;
                    let content = "";

                    // è§£ç å°è¯•é¡ºåºï¼šUTF-8 â†’ UTF-16LE â†’ GBK
                    const decoders = [
                        { name: 'UTF-8', decoder: new TextDecoder('utf-8', { fatal: true }) },
                        { name: 'UTF-16LE', decoder: new TextDecoder('utf-16le', { fatal: true }) }, // æ–°å¢UTF-16LEæ”¯æŒ
                        { name: 'GBK', decoder: new TextDecoder('gbk', { fatal: true }) }
                    ];

                    for (const { name, decoder } of decoders) {
                        try {
                            content = decoder.decode(buffer);
                            encoding = name;
                            break; // è§£ç æˆåŠŸåˆ™è·³å‡ºå¾ªç¯
                        } catch (e) {
                            continue; // è§£ç å¤±è´¥åˆ™å°è¯•ä¸‹ä¸€ç§ç¼–ç 
                        }
                    }

                    if (encoding) {
                        txtContent = content;
                        encodingInfo.innerHTML = `ç¼–ç : <strong>${encoding}</strong> | å·²æˆåŠŸè§£ç `;
                    } else {
                        // æ‰€æœ‰ç¼–ç å°è¯•å¤±è´¥æ—¶
                        txtContent = "";
                        encodingInfo.innerHTML = "ç¼–ç : <strong>æ— æ³•è¯†åˆ«</strong> | è¯·å°è¯•å…¶ä»–ç¼–ç æ ¼å¼çš„æ–‡ä»¶";
                    }
                };
                reader.readAsArrayBuffer(file);
            }
        });
        
        // å°é¢é¢„è§ˆ
        const coverFileInput = document.getElementById('cover-file');
        coverFileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const coverPreview = document.getElementById('cover-preview');
                    const coverImage = document.getElementById('cover-image');
                    const coverFilename = document.getElementById('cover-filename');
                    
                    coverImage.src = event.target.result;
                    coverFilename.textContent = file.name;
                    coverPreview.style.display = 'flex';
                    
                    // ä¿å­˜å°é¢æ–‡ä»¶ä¿¡æ¯
                    coverImageFile = file;
                    coverImageType = file.type;
                };
                reader.readAsDataURL(file);
            }
        });
        
        // æ‹–æ”¾æ–‡ä»¶æ”¯æŒ
        const uploadSection = document.querySelector('.file-upload');
        uploadSection.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.style.borderColor = '#4361ee';
            this.style.backgroundColor = 'rgba(67, 97, 238, 0.1)';
        });
        
        uploadSection.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.style.borderColor = '';
            this.style.backgroundColor = '';
        });
        
        uploadSection.addEventListener('drop', function(e) {
            e.preventDefault();
            this.style.borderColor = '';
            this.style.backgroundColor = '';
            
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                const event = new Event('change', { bubbles: true });
                fileInput.dispatchEvent(event);
            }
        });
        
        // ç« èŠ‚è¯†åˆ«é€»è¾‘ï¼ˆæ ¸å¿ƒä¼˜åŒ–ï¼‰ - ä¿®æ”¹ç‚¹ï¼šä½¿ç”¨æ•´è¡Œä½œä¸ºæ ‡é¢˜
        function identifyChapters() {
            if (!txtContent) {
                showError("å†…å®¹ä¸ºç©º", "æœªæ£€æµ‹åˆ°æœ‰æ•ˆçš„æ–‡æœ¬å†…å®¹", "è¯·ç¡®ä¿å·²ä¸Šä¼ æœ‰æ•ˆçš„TXTæ–‡ä»¶å¹¶åŒ…å«ç« èŠ‚å†…å®¹");
                return [];
            }
            
            const lines = txtContent.split('\n');
            chapters = [];
            const level3Enabled = document.getElementById('toggle-level3').checked;
            
            // è·å–ç”¨æˆ·é…ç½®
            const l1Prefix = document.getElementById('l1-prefix').value || '';
            const l1Suffix = document.getElementById('l1-suffix').value || '';
            const l1Separator = document.getElementById('l1-separator').value || '';
            const l1NumType = document.getElementById('l1-numtype').value;
            
            const l2Prefix = document.getElementById('l2-prefix').value || '';
            const l2Suffix = document.getElementById('l2-suffix').value || '';
            const l2Separator = document.getElementById('l2-separator').value || '';
            const l2NumType = document.getElementById('l2-numtype').value;
            
            let l3Prefix = '';
            let l3Suffix = '';
            let l3Separator = '';
            let l3NumType = '';
            
            if (level3Enabled) {
                l3Prefix = document.getElementById('l3-prefix').value || '';
                l3Suffix = document.getElementById('l3-suffix').value || '';
                l3Separator = document.getElementById('l3-separator').value || '';
                l3NumType = document.getElementById('l3-numtype').value;
            }
            
            // è·å–ç« èŠ‚è¯†åˆ«å‚æ•°
            const maxTitleLength = parseInt(document.getElementById('max-title-length').value) || 50;
            const minGapBefore = parseInt(document.getElementById('min-gap-before').value) || 0;
            const minGapAfter = parseInt(document.getElementById('min-gap-after').value) || 0;
            
            // æ„å»ºæ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼ - æ”¯æŒçº¯æ•°å­—ç« èŠ‚
            const buildPattern = (prefix, suffix, separator, numType) => {
                let pattern = '^';
                
                // å¤„ç†å‰ç¼€ - å¦‚æœå­˜åœ¨åˆ™å¿…é¡»åŒ¹é…
                if (prefix) {
                    pattern += `(?:${prefix.replace(/\|/g, '|')})`;
                }
                
                // å¤„ç†æ•°å­—
                const chineseNums = 'é›¶ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒ';
                if (numType === 'chinese') {
                    pattern += `([${chineseNums}]+)`;
                } else if (numType === 'arabic') {
                    pattern += '(\\d+)';
                } else {
                    pattern += `([${chineseNums}\\d]+)`;
                }
                
                // å¤„ç†åç¼€ - å¦‚æœå­˜åœ¨åˆ™å¿…é¡»åŒ¹é…
                if (suffix) {
                    pattern += `(?:${suffix.replace(/\|/g, '|')})`;
                }
                
                // å¤„ç†åˆ†éš”ç¬¦
                if (separator) {
                    pattern += `\\s*${separator.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\s*`;
                } else {
                    pattern += '\\s*'; // å¦‚æœæ²¡æœ‰åˆ†éš”ç¬¦ï¼Œæ•°å­—å’Œæ ‡é¢˜ä¹‹é—´å…è®¸æœ‰ç©ºæ ¼
                }
                
                // æ ‡é¢˜éƒ¨åˆ†æ”¹ä¸ºå¯é€‰ï¼Œæ”¯æŒçº¯æ•°å­—ç« èŠ‚
                pattern += '(.+)?$';
                return new RegExp(pattern);
            };
            
            const level1Pattern = buildPattern(l1Prefix, l1Suffix, l1Separator, l1NumType);
            const level2Pattern = buildPattern(l2Prefix, l2Suffix, l2Separator, l2NumType);
            const level3Pattern = level3Enabled ? 
                buildPattern(l3Prefix, l3Suffix, l3Separator, l3NumType) : null;
            
            // è¯†åˆ«ç« èŠ‚ - ä¿®æ”¹ç‚¹ï¼šä½¿ç”¨æ•´è¡Œä½œä¸ºæ ‡é¢˜
            outer: for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                // è·³è¿‡ç©ºè¡Œ
                if (!line) continue;
                
                // æ£€æŸ¥è¡Œé•¿åº¦é™åˆ¶
                if (line.length > maxTitleLength) continue;
                
                // æ£€æŸ¥æ ‡é¢˜å‰ç©ºè¡Œ
                if (minGapBefore > 0) {
                    for (let j = 1; j <= minGapBefore; j++) {
                        if (i - j >= 0 && lines[i - j].trim() !== '') {
                            continue outer;
                        }
                    }
                }
                
                // æ£€æŸ¥æ ‡é¢˜åç©ºè¡Œ
                if (minGapAfter > 0) {
                    for (let j = 1; j <= minGapAfter; j++) {
                        if (i + j < lines.length && lines[i + j].trim() !== '') {
                            continue outer;
                        }
                    }
                }
                
                // å°è¯•åŒ¹é…ä¸åŒå±‚çº§ - ä¿®æ”¹ç‚¹ï¼šç›´æ¥ä½¿ç”¨æ•´è¡Œä½œä¸ºæ ‡é¢˜
                let match;
                if ((match = line.match(level1Pattern))) {
                    chapters.push({
                        level: 1,
                        title: line,  // ä½¿ç”¨æ•´è¡Œä½œä¸ºæ ‡é¢˜
                        line: i + 1,
                        valid: true
                    });
                } else if ((match = line.match(level2Pattern))) {
                    chapters.push({
                        level: 2,
                        title: line,  // ä½¿ç”¨æ•´è¡Œä½œä¸ºæ ‡é¢˜
                        line: i + 1,
                        valid: true
                    });
                } else if (level3Enabled && (match = line.match(level3Pattern))) {
                    chapters.push({
                        level: 3,
                        title: line,  // ä½¿ç”¨æ•´è¡Œä½œä¸ºæ ‡é¢˜
                        line: i + 1,
                        valid: true
                    });
                }
            }
            
            // éªŒè¯ç« èŠ‚ç»“æ„
            validateChapterStructure();
            
            return chapters;
        }
        
        // ç« èŠ‚ç»“æ„éªŒè¯
        function validateChapterStructure() {
            let lastLevel = 0;
            
            for (let i = 0; i < chapters.length; i++) {
                const chapter = chapters[i];
                
                // æ£€æŸ¥å±‚çº§è·³è·ƒï¼ˆä¾‹å¦‚ä»1çº§ç›´æ¥åˆ°3çº§ï¼‰
                if (chapter.level > lastLevel + 1) {
                    chapter.valid = false;
                }
                
                lastLevel = chapter.level;
            }
        }
        
        // è½¬æ¢EPUBåŠŸèƒ½
        function convertToEpub() {
            // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²ä¸Šä¼ 
            if (!fileInput.files.length) {
                showError("æ–‡ä»¶æœªä¸Šä¼ ", "è¯·å…ˆä¸Šä¼ TXTæ–‡ä»¶", "è¿”å›ç¬¬ä¸€æ­¥ä¸Šä¼ æœ‰æ•ˆçš„TXTæ–‡ä»¶");
                nextStep(1);
                return;
            }
            
            // æ£€æŸ¥ç« èŠ‚ä¿¡æ¯
            if (chapters.length === 0) {
                showError("ç« èŠ‚è¯†åˆ«å¤±è´¥", "æœªæ£€æµ‹åˆ°æœ‰æ•ˆçš„ç« èŠ‚ç»“æ„", "è¯·è°ƒæ•´ç« èŠ‚è§„åˆ™è®¾ç½®æˆ–è¿”å›ç¬¬ä¸‰æ­¥é‡æ–°é…ç½®");
                nextStep(3);
                return;
            }
            
            // æ›´æ–°è¾“å‡ºä¿¡æ¯
            document.getElementById('output-title').value = document.getElementById('epub-title').value;
            document.getElementById('output-author').value = document.getElementById('epub-author').value;
            epubFileName = document.getElementById('epub-filename').value + '.epub';
            document.getElementById('output-filename').value = epubFileName;
            document.getElementById('output-chapters').value = chapters.length + ' ç« ';
            
            // å¼€å§‹è½¬æ¢
            generateEpubFile();
        }
        
        // æ–‡ä»¶åå®‰å…¨è¿‡æ»¤
        function sanitizeFilename(name) {
            return name.replace(/[\\/:*?"<>|]/g, '');
        }
        
        // æ›´æ–°è¿›åº¦æ¡
        function updateProgress(percent, stage) {
            const progressBar = document.getElementById('progress-bar');
            const progressStage = document.getElementById('progress-stage');
            
            progressBar.style.width = `${percent}%`;
            progressStage.textContent = stage;
        }
        
        // æ„å»ºç« èŠ‚æ ‘ç»“æ„ï¼ˆä¿®å¤ç›®å½•é—®é¢˜ï¼‰
        function buildChapterTree() {
            const tree = [];
            const stack = [];
            let idCounter = 0;
            
            for (const chapter of chapters) {
                if (!chapter.valid) continue;
                
                // åˆ›å»ºèŠ‚ç‚¹
                const node = {
                    id: `chapter-${++idCounter}`,
                    level: chapter.level,
                    title: chapter.title,
                    line: chapter.line,
                    children: []
                };
                
                // å¯»æ‰¾åˆé€‚çš„çˆ¶èŠ‚ç‚¹
                while (stack.length > 0 && stack[stack.length - 1].level >= node.level) {
                    stack.pop();
                }
                
                if (stack.length === 0) {
                    // æ ¹èŠ‚ç‚¹
                    tree.push(node);
                } else {
                    // æ·»åŠ åˆ°çˆ¶èŠ‚ç‚¹çš„children
                    stack[stack.length - 1].children.push(node);
                }
                
                // å°†å½“å‰èŠ‚ç‚¹å‹å…¥æ ˆ
                stack.push(node);
            }
            
            return tree;
        }
        
        // EPUBæ–‡ä»¶ç”Ÿæˆæ ¸å¿ƒé€»è¾‘ï¼ˆä¿®å¤ç‰ˆï¼‰
        function generateEpubFile() {
            const title = document.getElementById('epub-title').value || 'æœªå‘½åä¹¦ç±';
            const author = document.getElementById('epub-author').value || 'æœªçŸ¥ä½œè€…';
            const fileName = sanitizeFilename(
                document.getElementById('epub-filename').value || 'ebook'
            );
            
            const convertBtn = document.getElementById('convert-btn');
            convertBtn.disabled = true;
            convertBtn.innerHTML = 'è½¬æ¢ä¸­ <i class="fas fa-spinner fa-spin"></i>';
            
            try {
                // åˆ›å»ºEPUBä¹¦ç±å¯¹è±¡
                const book = new JSZip();
                currentBook = book;
                
                // åŸºæœ¬æ–‡ä»¶ç»“æ„
                book.file("mimetype", "application/epub+zip");
                const META_INF = book.folder("META-INF");
                META_INF.file("container.xml", `<?xml version="1.0"?>
<container version="1.0" xmlns="urn:oasis:names:tc:opendocument:xmlns:container">
  <rootfiles>
    <rootfile full-path="OEBPS/content.opf" media-type="application/oebps-package+xml"/>
  </rootfiles>
</container>`);
                
                const OEBPS = book.folder("OEBPS");
                
                // ç”Ÿæˆå†…å®¹æ–‡ä»¶
                updateProgress(10, "å¤„ç†ç« èŠ‚å†…å®¹...");
                
                // åˆ›å»ºå°é¢é¡µ - ä¿®å¤iOSå…¼å®¹æ€§é—®é¢˜
                let coverHtml = `<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
<head>
  <title>${title} - å°é¢</title>
  <style>
    body { 
        margin: 0; 
        padding: 0; 
        text-align: center; 
        background: #f8f9fa; 
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
    }
    .cover-container { 
        max-width: 80%;
        text-align: center;
    }
    .cover-title { 
        font-size: 1.1rem;  /* ä¸æ­£æ–‡å­—ä½“å¤§å°ç›¸åŒ */
        font-weight: bold;
        margin-bottom: 0.5rem;
        color: #333;
        text-align: center;
        width: 100%;
    }
    .cover-author { 
        font-size: 1.1rem;  /* ä¸æ­£æ–‡å­—ä½“å¤§å°ç›¸åŒ */
        color: #666;
        text-align: center;
        width: 100%;
    }
    .cover-image { 
        max-width: 60%; 
        max-height: 60vh; 
        margin: 0 auto 1.5rem; 
        border: 1px solid #ddd; 
        box-shadow: 0 5px 20px rgba(0,0,0,0.1); 
        border-radius: 5px; 
    }
  </style>
</head>
<body>
  <div class="cover-container">`;
                
                // æ·»åŠ å°é¢å›¾ç‰‡ï¼ˆå¦‚æœä¸Šä¼ äº†ï¼‰
                let coverImageName = "";
                let mediaType = "";
                
                if (coverImageFile) {
                    coverImageName = `cover.${coverImageType.split('/')[1]}`;
                    mediaType = coverImageType;
                    
                    // æ·»åŠ å°é¢å›¾ç‰‡åˆ°EPUB
                    OEBPS.file(coverImageName, coverImageFile);
                    
                    // åœ¨å°é¢é¡µä¸­åŒ…å«å›¾ç‰‡ - ä¿®å¤iOSå…¼å®¹æ€§é—®é¢˜ï¼ˆæ­£ç¡®ä½¿ç”¨è‡ªé—­åˆæ ‡ç­¾ï¼‰
                    coverHtml += `
    <img class="cover-image" src="${coverImageName}" alt="${title} å°é¢" />
    <div class="cover-title">${title}</div>
    <div class="cover-author">${author}</div>
  </div>
</body>
</html>`;
                } else {
                    // æ²¡æœ‰å°é¢å›¾ç‰‡æ—¶ä½¿ç”¨æ–‡å­—å°é¢
                    coverHtml += `
    <div class="cover-title">${title}</div>
    <div class="cover-author">${author}</div>
    <div style="margin-top: 2em; font-style: italic; color: #777; font-size: 1.1rem;">
      æœ¬ä¹¦ç”±TXTè½¬EPUBå·¥å…·ç”Ÿæˆ<br />
      ${new Date().toLocaleDateString()}
    </div>
  </div>
</body>
</html>`;
                }
                
                OEBPS.file("cover.html", coverHtml);
                
                // åˆ›å»ºç›®å½•HTMLæ–‡ä»¶
                updateProgress(20, "ç”Ÿæˆç›®å½•ç»“æ„...");
                let tocHtml = `<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
<head>
  <title>ç›®å½•</title>
  <style>
    body { font-family: sans-serif; line-height: 1.6; margin: 0; padding: 20px; background: #f8f9fa; }
    h1 { text-align: center; margin-bottom: 30px; color: #333; }
    nav ol { list-style: none; padding: 0; max-width: 800px; margin: 0 auto; }
    nav li { padding: 12px 15px; border-bottom: 1px solid #eee; background: white; }
    nav a { text-decoration: none; color: #333; display: block; font-size: 1.1rem; }
    nav li.level-1 { font-weight: bold; padding-left: 20px; border-left: 4px solid #4361ee; }
    nav li.level-2 { padding-left: 40px; border-left: 4px solid #4895ef; }
    nav li.level-3 { padding-left: 60px; font-size: 1rem; border-left: 4px solid #f9a826; }
    nav li:hover { background: #f0f4ff; }
  </style>
</head>
<body>
  <h1>${title}</h1>
  <h2 style="text-align: center; color: #666; margin-bottom: 30px;">ç›®å½•</h2>
  <nav id="toc" epub:type="toc">
    <ol>
      <li class="level-0">
        <a href="cover.html">å°é¢</a>
      </li>`;

                // æå–ç®€ä»‹å†…å®¹ï¼ˆç¬¬ä¸€ç« ä¹‹å‰çš„å†…å®¹ï¼‰
                let introContent = '';
                let introHtml = '';
                let introExists = false;
                
                if (chapters.length > 0) {
                    const firstChapterLine = chapters[0].line - 1; // ç« èŠ‚è¡Œå·ä»1å¼€å§‹ï¼Œè½¬æ¢ä¸ºç´¢å¼•
                    const contentLines = txtContent.split('\n');
                    
                    // æå–ä»0è¡Œåˆ°firstChapterLine-1è¡Œï¼ˆç®€ä»‹ä¸åŒ…æ‹¬ç« èŠ‚æ ‡é¢˜è¡Œï¼‰
                    for (let j = 0; j < firstChapterLine; j++) {
                        if (contentLines[j].trim() !== '') {
                            introContent += `<p>${contentLines[j]}</p>\n`;
                        }
                    }
                    
                    // å¦‚æœç®€ä»‹å†…å®¹éç©ºï¼Œåˆ™ç”Ÿæˆç®€ä»‹ç« èŠ‚
                    if (introContent.trim() !== '') {
                        introExists = true;
                        
                        // ç”Ÿæˆç®€ä»‹çš„HTMLæ–‡ä»¶
                        introHtml = `<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
<head>
  <title>ç®€ä»‹</title>
  <style>
    body { font-family: serif; line-height: 1.8; margin: 0; padding: 30px; background: none; color: inherit; }
    .intro-title { font-size: 2.2rem; text-align: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px solid #eee; color: #222; }
    .intro-content { margin-top: 1.5rem; text-indent: 2em; font-size: 1.1rem; }
  </style>
</head>
<body>
  <h1 class="intro-title">ç®€ä»‹</h1>
  <div class="intro-content">\n${introContent}\n  </div>
</body>
</html>`;
                        
                        OEBPS.file("intro.html", introHtml);
                        
                        // åœ¨ç›®å½•ä¸­æ·»åŠ ç®€ä»‹
                        tocHtml += `
      <li class="level-0">
        <a href="intro.html">ç®€ä»‹</a>
      </li>`;
                    }
                }
                
                // æ„å»ºç« èŠ‚æ ‘ç»“æ„ï¼ˆä¿®å¤ç›®å½•é—®é¢˜ï¼‰
                const chapterTree = buildChapterTree();
                
                // é€’å½’ç”ŸæˆåµŒå¥—ç›®å½•HTML
                function generateTocHtml(tree) {
                    let html = '';
                    for (const node of tree) {
                        html += `
          <li class="level-${node.level}">
            <a href="${node.id}.html">${node.title}</a>`;
                        
                        if (node.children.length > 0) {
                            html += `
            <ol>${generateTocHtml(node.children)}</ol>`;
                        }
                        
                        html += `
          </li>`;
                    }
                    return html;
                }
                
                // æ·»åŠ ç« èŠ‚åˆ°ç›®å½•
                tocHtml += generateTocHtml(chapterTree);
                
                tocHtml += `
    </ol>
  </nav>
</body>
</html>`;
                
                OEBPS.file("toc.html", tocHtml);
                
                // æ·»åŠ ç« èŠ‚å†…å®¹
                updateProgress(30, "ç”Ÿæˆç« èŠ‚å†…å®¹...");
                let currentChapterStart = 0;
                const contentLines = txtContent.split('\n');
                
                // é€’å½’ç”Ÿæˆç« èŠ‚HTMLæ–‡ä»¶
                function generateChapterFiles(tree) {
                    for (const node of tree) {
                        // åˆ›å»ºç« èŠ‚HTMLæ–‡ä»¶
                        let chapterHtml = `<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
<head>
  <title>${node.title}</title>
  <style>
    body { font-family: serif; line-height: 1.8; margin: 0; padding: 30px; background: none; color: inherit; }
    .chapter-title { font-size: 2.2rem; text-align: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px solid #eee; color: #222; }
    .chapter-content { margin-top: 1.5rem; text-indent: 2em; font-size: 1.1rem; }
  </style>
</head>
<body>
  <h1 class="chapter-title">${node.title}</h1>
  <div class="chapter-content">\n`;
                        
                        // æ·»åŠ ç« èŠ‚å†…å®¹
                        const nextIndex = chapters.findIndex(c => c.line > node.line);
                        const endLine = nextIndex >= 0 ? chapters[nextIndex].line - 1 : contentLines.length;
                        
                        for (let j = node.line - 1; j < endLine; j++) {
                            // è·³è¿‡ç« èŠ‚æ ‡é¢˜è¡Œï¼ˆé¿å…åœ¨å†…å®¹ä¸­é‡å¤å‡ºç°æ ‡é¢˜ï¼‰
                            if (j !== (node.line - 1) && contentLines[j].trim() !== '') {
                                chapterHtml += `<p>${contentLines[j]}</p>\n`;
                            }
                        }
                        
                        chapterHtml += `  </div>
</body>
</html>`;
                        
                        // ä¿å­˜ç« èŠ‚HTMLæ–‡ä»¶
                        OEBPS.file(`${node.id}.html`, chapterHtml);
                        
                        // é€’å½’å¤„ç†å­èŠ‚ç‚¹
                        if (node.children.length > 0) {
                            generateChapterFiles(node.children);
                        }
                    }
                }
                
                // ç”Ÿæˆæ‰€æœ‰ç« èŠ‚æ–‡ä»¶
                generateChapterFiles(chapterTree);
                
                // ç”ŸæˆOPFæ–‡ä»¶ï¼ˆä¿®å¤ç›®å½•é—®é¢˜ï¼‰
                updateProgress(60, "ç”Ÿæˆå…ƒæ•°æ®...");
                
                // é€’å½’ç”Ÿæˆmanifestå’Œspineå†…å®¹
                function generateManifestAndSpine(tree) {
                    let manifest = '';
                    let spine = '';
                    
                    function traverse(node) {
                        manifest += `<item id="${node.id}" href="${node.id}.html" media-type="application/xhtml+xml"/>\n    `;
                        spine += `<itemref idref="${node.id}"/>\n    `;
                        
                        for (const child of node.children) {
                            traverse(child);
                        }
                    }
                    
                    for (const node of tree) {
                        traverse(node);
                    }
                    
                    return { manifest, spine };
                }
                
                const { manifest: chapterManifest, spine: chapterSpine } = generateManifestAndSpine(chapterTree);
                
                const opfContent = `<?xml version="1.0" encoding="UTF-8"?>
<package xmlns="http://www.idpf.org/2007/opf" unique-identifier="bookid" version="3.0">
  <metadata xmlns:dc="http://purl.org/dc/elements/1.1/">
    <dc:identifier id="bookid">urn:uuid:${generateUUID()}</dc:identifier>
    <dc:title>${title}</dc:title>
    <dc:creator>${author}</dc:creator>
    <dc:language>zh-CN</dc:language>
    <meta property="dcterms:modified">${new Date().toISOString()}</meta>
    ${coverImageName ? `<meta name="cover" content="cover-image"/>` : ''}
  </metadata>
  <manifest>
    <item id="cover" href="cover.html" media-type="application/xhtml+xml"/>
    <item id="toc" href="toc.html" media-type="application/xhtml+xml" properties="nav"/>
    <item id="ncx" href="toc.ncx" media-type="application/x-dtbncx+xml"/>
    ${coverImageName ? `<item id="cover-image" href="${coverImageName}" media-type="${mediaType}" properties="cover-image"/>` : ''}
    ${introExists ? `<item id="intro" href="intro.html" media-type="application/xhtml+xml"/>` : ''}
    
    <!-- ç« èŠ‚æ–‡ä»¶ -->
    ${chapterManifest}
  </manifest>
  <spine toc="ncx">
    <itemref idref="cover"/>
    ${introExists ? `<itemref idref="intro"/>` : ''}
    ${chapterSpine}
  </spine>
  <guide>
    <reference type="cover" title="å°é¢" href="cover.html"/>
    <reference type="toc" title="ç›®å½•" href="toc.html"/>
  </guide>
</package>`;
                
                OEBPS.file("content.opf", opfContent);
                
                // ç”ŸæˆNCXæ–‡ä»¶ï¼ˆä¿®å¤ç›®å½•é—®é¢˜ï¼‰
                updateProgress(80, "ç”Ÿæˆç›®å½•ç´¢å¼•...");
                
                // é€’å½’ç”ŸæˆNCXå¯¼èˆªç‚¹
                function generateNcxNavPoints(tree, playOrder = 1) {
                    let navContent = '';
                    let currentOrder = playOrder;
                    
                    for (const node of tree) {
                        navContent += `
    <navPoint id="${node.id}" playOrder="${currentOrder++}">
      <navLabel>
        <text>${node.title}</text>
      </navLabel>
      <content src="${node.id}.html"/>`;
                        
                        if (node.children.length > 0) {
                            const childContent = generateNcxNavPoints(node.children, currentOrder);
                            navContent += childContent.content;
                            currentOrder = childContent.nextOrder;
                        }
                        
                        navContent += `
    </navPoint>`;
                    }
                    
                    return { content: navContent, nextOrder: currentOrder };
                }
                
                // ç”ŸæˆNCXå†…å®¹
                const ncxStartOrder = introExists ? 3 : 2;
                const ncxNavContent = generateNcxNavPoints(chapterTree, ncxStartOrder);
                
                let ncxContent = `<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE ncx PUBLIC "-//NISO//DTD ncx 2005-1//EN" "http://www.daisy.org/z3986/2005/ncx-2005-1.dtd">
<ncx xmlns="http://www.daisy.org/z3986/2005/ncx/" version="2005-1">
  <head>
    <meta name="dtb:uid" content="urn:uuid:${generateUUID()}"/>
  </head>
  <docTitle>
    <text>${title}</text>
  </docTitle>
  <navMap>
    <navPoint id="cover" playOrder="1">
      <navLabel>
        <text>å°é¢</text>
      </navLabel>
      <content src="cover.html"/>
    </navPoint>`;
                
                // æ·»åŠ ç®€ä»‹åˆ°NCXï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                if (introExists) {
                    ncxContent += `
    <navPoint id="intro" playOrder="2">
      <navLabel>
        <text>ç®€ä»‹</text>
      </navLabel>
      <content src="intro.html"/>
    </navPoint>`;
                }
                
                // æ·»åŠ ç« èŠ‚åˆ°NCX
                ncxContent += ncxNavContent.content;
                
                ncxContent += `
  </navMap>
</ncx>`;
                
                OEBPS.file("toc.ncx", ncxContent);
                
                // ç”ŸæˆEPUBæ–‡ä»¶å¹¶ä¸‹è½½
                updateProgress(90, "æ‰“åŒ…EPUBæ–‡ä»¶...");
                book.generateAsync({
                    type: "blob",
                    mimeType: "application/epub+zip",
                    compression: "DEFLATE",
                    compressionOptions: { level: 6 }
                }, (metadata) => {
                    // å®æ—¶æ›´æ–°è¿›åº¦æ¡
                    updateProgress(90 + Math.floor(metadata.percent * 0.1), "æ‰“åŒ…EPUBæ–‡ä»¶...");
                }).then(function(content) {
                    updateProgress(100, "è½¬æ¢å®Œæˆ");
                    
                    // ä¿å­˜ç”Ÿæˆçš„blob
                    generatedEpubBlob = content;
                    
                    // æ›´æ–°ç•Œé¢ä¸ºè½¬æ¢æˆåŠŸçŠ¶æ€
                    document.getElementById('convert-info').className = 'alert alert-success';
                    document.getElementById('convert-info').innerHTML = `
                        <i class="fas fa-check-circle"></i>
                        <div>
                            <strong>è½¬æ¢æˆåŠŸ!</strong> 
                            <p>EPUBæ–‡ä»¶å·²ç”Ÿæˆï¼ŒåŒ…å« ${chapters.length} ä¸ªç« èŠ‚${introExists ? 'åŠç®€ä»‹' : ''}</p>
                        </div>
                    `;
                    
                    // æ˜¾ç¤ºä¸‹è½½æŒ‰é’®
                    const downloadSection = document.getElementById('download-section');
                    downloadSection.style.display = 'block';
                    
                    // å°è¯•è‡ªåŠ¨ä¸‹è½½ï¼ˆåœ¨iOSçš„æœ¬åœ°ç¯å¢ƒä¸­ä¸è‡ªåŠ¨ä¸‹è½½ï¼‰
                    if (!isLocalEnvironment() || !isIOS()) {
                        saveAs(generatedEpubBlob, epubFileName);
                    }
                    
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    convertBtn.disabled = false;
                    convertBtn.innerHTML = 'é‡æ–°è½¬æ¢ <i class="fas fa-redo"></i>';
                }).catch(function(err) {
                    console.error("ç”ŸæˆEPUBå¤±è´¥", err);
                    showError("ç”ŸæˆEPUBå¤±è´¥", err.message || "æœªçŸ¥é”™è¯¯", "è¯·å°è¯•å‡å°‘ç« èŠ‚æ•°é‡æˆ–æ‹†åˆ†å¤§æ–‡ä»¶");
                    
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    convertBtn.disabled = false;
                    convertBtn.innerHTML = 'é‡æ–°å°è¯• <i class="fas fa-redo"></i>';
                });
            } catch (err) {
                console.error("ç”ŸæˆEPUBå¤±è´¥", err);
                showError("ç”ŸæˆEPUBå¤±è´¥", err.message || "æœªçŸ¥é”™è¯¯", "è¯·æ£€æŸ¥æ–‡ä»¶å†…å®¹å¹¶é‡è¯•");
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                convertBtn.disabled = false;
                convertBtn.innerHTML = 'é‡æ–°å°è¯• <i class="fas fa-redo"></i>';
            }
        }
        
        // ç”ŸæˆUUID
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0,
                      v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        
        // åˆå§‹åŒ–å·¥å…·
        function initTool() {
            // æ·»åŠ ä¸‹è½½æŒ‰é’®äº‹ä»¶ç›‘å¬
            document.getElementById('download-btn').addEventListener('click', function() {
                if (generatedEpubBlob) {
                    saveAs(generatedEpubBlob, epubFileName);
                } else {
                    showError("æ–‡ä»¶æœªç”Ÿæˆ", "EPUBæ–‡ä»¶å°šæœªç”Ÿæˆæˆ–å·²è¿‡æœŸ", "è¯·è¿”å›ç¬¬äº”æ­¥é‡æ–°ç”ŸæˆEPUBæ–‡ä»¶");
                }
            });
            
            // æ·»åŠ å…³é—­æ¨¡æ€æ¡†çš„ESCé”®æ”¯æŒ
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeModal();
                    closeErrorModal();
                }
            });
        }
        
        // å¼€å§‹åŠ è½½åº“
        loadLibraries();
    </script>
</body>
</html>
